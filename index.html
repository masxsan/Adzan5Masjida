<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jadwal Sholat TV Masjid</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1a4d2e 0%, #0d2818 100%);
        }
        
        .gold-border {
            border: 2px solid #d4af37;
        }
        
        .shadow-custom {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .active-prayer {
            background: linear-gradient(135deg, #d4af37 0%, #c9a636 100%);
            transform: scale(1.05);
        }
        
        .prayer-card {
            transition: all 0.3s ease;
        }
        
        .table-row {
            border-bottom: 1px solid rgba(212, 175, 55, 0.05);
        }
        
        @keyframes scrollUp {
            0% { transform: translateY(0); }
            100% { transform: translateY(-50%); }
        }
        .scroll-active {
            animation: scrollUp linear infinite;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes glowSoft {
            0%, 100% { box-shadow: 0 0 18px rgba(212, 175, 55, 0.45); transform: scale(1.05); }
            50% { box-shadow: 0 0 28px rgba(212, 175, 55, 0.75); transform: scale(1.07); }
        }
        .glow-pulse {
            animation: glowSoft 2.5s ease-in-out infinite;
        }
        
        @keyframes softPulse1s {
            0%, 100% { box-shadow: 0 0 22px rgba(212, 175, 55, 0.9), 0 0 44px rgba(212, 175, 55, 0.5); }
            50% { box-shadow: 0 0 10px rgba(212, 175, 55, 0.3), 0 0 20px rgba(212, 175, 55, 0.15); }
        }
        .soft-pulse-1s {
            animation: softPulse1s 1s ease-in-out infinite;
            will-change: box-shadow;
            border: 2px solid rgba(212, 175, 55, 0.9);
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; filter: blur(2px); }
            100% { opacity: 1; filter: none; }
        }
    </style>
  <style>
        /* --- ACTIVATION SCREEN STYLES --- */
        #activation-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0d2818, #000);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .activation-card {
            background: white;
            color: #333;
            padding: 2.5rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            border-top: 5px solid #d4af37;
            text-align: center;
        }

        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: #333; }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
            background: #fff;
            color: #333;
        }
        .input-field:focus { outline: none; border-color: #1a4d2e; }
        
        .btn-activate {
            background: #1a4d2e;
            color: white;
            border: none;
            width: 100%;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-activate:hover { background: #0f2e1b; }
        .error-msg { color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem; display: none; }
        .hidden { display: none !important; }
    </style>
    <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full w-full">
    <!-- ACTIVATION SCREEN -->
    <div id="activation-screen">
        <div class="activation-card">
            <h2 style="font-size: 1.8rem; margin-bottom: 0.5rem; color: #1a4d2e; font-weight: 800;">Aktivasi Perangkat</h2>
            <p style="margin-bottom: 2rem; color: #666;">Silakan masukkan Kode Aktivasi dan Data Master untuk memulai.</p>
            
            <div class="input-group">
                <label class="input-label">Kode Aktivasi</label>
                <input type="text" id="act-code" class="input-field" placeholder="ALM-XXXX-XXXX" style="text-transform: uppercase;">
            </div>

            <div class="input-group">
                <label class="input-label">Upload File Master (.json)</label>
                <input type="file" id="act-file" class="input-field" accept=".json" style="padding: 0.5rem;">
            </div>

            <!-- Hidden manual input -->
            <div class="input-group" style="display: none;">
                <label class="input-label">Atau Paste Data Manual</label>
                <textarea id="act-data" class="input-field" placeholder='Paste data JSON disini jika tidak upload file...' style="min-height: 80px;"></textarea>
                <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">*Data diperlukan untuk validasi offline</div>
            </div>

            <div id="act-error" class="error-msg">Kode tidak valid atau tidak ditemukan di data master.</div>

            <button onclick="attemptActivation()" class="btn-activate">AKTIFKAN PERANGKAT</button>
        </div>
    </div>
 <div id="main-container" class="h-full w-full gradient-bg text-white overflow-auto" style="height: 100vh; display: grid; grid-template-rows: 14vh 12vh calc(50vh + 1cm) calc(24vh - 1cm); overflow: hidden;"><!-- Header Banner -->
   <div id="header-banner" class="gold-border" style="background: linear-gradient(90deg, #1a4d2e 0%, #2d6b42 50%, #1a4d2e 100%); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center;"><!-- Jam Digital -->
    <div style="flex: 1;">
     <div id="current-time" style="font-size: 36px; font-weight: 800; color: white; letter-spacing: 2px;">
      00:00:00
     </div>
     <div id="current-date" style="font-size: 18px; color: white; margin-top: 2px;">
      Senin, 1 Januari 2024
     </div>
    </div><!-- Nama Masjid -->
    <div style="flex: 2; text-align: center;">
     <div id="mosque-name" style="font-size: 35px; font-weight: 800; color: #d4af37; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 4px;">
      MASJID AL-IKHLAS
     </div>
     <div id="mosque-address" style="font-size: 20px; color: white; opacity: 0.9; font-weight: 700;">
      Jl. Contoh No. 123, Jakarta Selatan
     </div><button id="open-settings-btn" style="margin-top: 8px; background: rgba(212, 175, 55, 0.2); border: 2px solid #d4af37; border-radius: 50%; width: 36px; height: 36px; color: #d4af37; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#d4af37'; this.style.color='#1a4d2e'; this.style.transform='rotate(90deg)'" onmouseout="this.style.background='rgba(212, 175, 55, 0.2)'; this.style.color='#d4af37'; this.style.transform='rotate(0deg)'">
      <svg style="width: 20px; height: 20px;" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
      </svg></button>
    </div><!-- Countdown -->
    <div style="flex: 1; text-align: right;">
     <div style="font-size: 11px; color: white; margin-bottom: 2px;">
      MENUJU
     </div>
     <div id="next-prayer-name" style="font-size: 16px; font-weight: 700; color: white;">
      DZUHUR
     </div>
     <div id="countdown" class="pulse" style="font-size: 24px; font-weight: 800; color: #d4af37; margin-top: 2px;">
      00:00:00
     </div>
    </div>
   </div><!-- Kartu Waktu Sholat -->
  <div style="padding: 16px 24px; height: 100%; overflow: hidden;">
    <div id="prayer-cards" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; min-height: 100px;"><!-- Cards will be inserted here -->
    </div>
   </div><!-- Body Tengah (4 Kolom) -->
  <div id="main-content-grid" style="padding: 0 24px 0 24px; display: grid; grid-template-columns: 0.75fr 0.75fr 2.8fr 0.75fr; gap: 12px; height: 100%; overflow: hidden;"><!-- Kolom Kiri 1+2: Foto Takmir dalam satu kontainer -->
   <div id="photos-container" style="grid-column: 1 / span 2; background: transparent; border-radius: 12px; padding: 0; border: none; box-shadow: none; display: grid; grid-template-columns: 1fr 1fr; gap: 0; height: calc(100% - 2cm); overflow: hidden;">
    <div id="left-col-1" style="display: flex; flex-direction: column; gap: 0px; height: 100%; min-height: 0;">
        <div style="background: transparent; border: none; padding: 0; flex: 1.3; display: flex; flex-direction: column; justify-content: center; box-shadow: none !important; -webkit-box-shadow: none !important; overflow: hidden; min-height: 0;">
            <div id="takmir-display-1" style="display: flex; flex-direction: column; gap: 10px; height: 100%;"></div>
        </div>
        <div id="takmir-display-3" style="flex: 0.7; display: flex; flex-direction: column; gap: 10px; justify-content: flex-start; align-items: center; width: 100%; height: 100%;"></div>
    </div><!-- Kolom Kiri 2: Foto Takmir -->
    <div id="left-col-2" style="display: flex; flex-direction: column; gap: 0px; height: 100%; min-height: 0;">
        <div style="background: transparent; border: none; padding: 0; flex: 1.3; display: flex; flex-direction: column; justify-content: center; box-shadow: none !important; -webkit-box-shadow: none !important; overflow: hidden; min-height: 0;">
            <div id="takmir-display-2" style="display: flex; flex-direction: column; gap: 10px; height: 100%;"></div>
        </div>
        <div id="takmir-display-4" style="flex: 0.7; display: flex; flex-direction: column; gap: 10px; justify-content: flex-start; align-items: center; width: 100%; height: 100%;"></div>
    </div>
   </div><!-- Kolom Tengah: Slideshow Pengumuman -->
   <div class="gold-border shadow-custom" style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 5px; height: calc(100% - 2cm); display: flex; flex-direction: column; position: relative; overflow: hidden; border: 2px solid #d4af37;">
     <div id="announcement-title-container" style="display: flex; align-items: center; margin-bottom: 10px;">
      <svg style="width: 20px; height: 20px; color: #d4af37; margin-right: 8px;" fill="currentColor" viewbox="0 0 20 20"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" />
      </svg>
      <div id="announcement-title" style="font-size: 25px; font-weight: 700; color: #d4af37;">
       PENGUMUMAN MASJID
      </div>
     </div><!-- Text Announcement -->
     <div id="text-announcement-container" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; overflow: hidden;">
      <div id="announcement-text" style="font-size: 22.5px; line-height: 1.8; color: white;">
       ${currentAnnouncement}
      </div>
     </div><!-- Slideshow Container -->
    <div id="slideshow-container" style="flex: 1; position: relative; border-radius: 0; overflow: hidden; background: rgba(0, 0, 0, 0.3); width: 100%; height: 100%; min-height: 0; margin: 0; display: none;"><!-- Slides will be inserted here -->
     </div><!-- Slide Navigation Dots -->
     <div id="slide-dots" style="display: none; justify-content: center; gap: 8px; margin-top: 12px;"><!-- Dots will be inserted here -->
     </div>
    </div><!-- Kolom Kanan: Info Masjid -->
   <div class="shadow-custom" style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 12px; border: 2px solid #d4af37; height: calc(100% - 2cm); overflow: hidden; min-height: 0;">
     <div style="font-size: 18.75px; font-weight: 700; color: #d4af37; margin-bottom: 10px; text-align: center;">
           ️ INFO MASJID
     </div>
     <div id="info-masjid-display" style="display: flex; flex-direction: column; gap: 8px; font-size: 10px; color: white;">
      <div style="background: rgba(212, 175, 55, 0.1); padding: 6px; border-radius: 6px; border-left: 3px solid #d4af37;">
       <div style="opacity: 0.8; font-size: 15px; font-weight: 600; margin-bottom: 2px;">
        Kapasitas
       </div>
       <div style="font-weight: 700; font-size: 14px;">
        500 Jamaah
       </div>
      </div>
      <div style="background: rgba(212, 175, 55, 0.1); padding: 6px; border-radius: 6px; border-left: 3px solid #d4af37;">
       <div style="opacity: 0.8; font-size: 15px; font-weight: 600; margin-bottom: 2px;">
        Fasilitas
       </div>
       <div style="font-weight: 700; font-size: 14px;">
        AC, Parkir
       </div>
      </div>
     
     <div style="background: rgba(212, 175, 55, 0.1); padding: 6px; border-radius: 6px; border-left: 3px solid #d4af37;">
       <div style="opacity: 0.8; font-size: 15px; font-weight: 600; margin-bottom: 2px;">
        Kontak
       </div>
       <div style="font-weight: 700; font-size: 14px;">
        0812-3456-7890
       </div>
      </div>
      <div style="background: rgba(212, 175, 55, 0.1); padding: 6px; border-radius: 6px; border-left: 3px solid #d4af37;">
       <div style="opacity: 0.8; font-size: 15px; font-weight: 600; margin-bottom: 2px;">
        Info Ramadhan/Raya
       </div>
       <div style="font-weight: 700; font-size: 14px;">
        Kajian Menjelang Berbuka
       </div>
      </div>
      <div style="background: rgba(212, 175, 55, 0.1); padding: 6px; border-radius: 6px; border-left: 3px solid #d4af37;">
        <div style="opacity: 0.8; font-size: 15px; font-weight: 600; margin-bottom: 2px;">
         Info Qurban
        </div>
        <div style="font-weight: 700; font-size: 14px;">
         Sapi: 3, Kambing: 15 (Panitia: Bpk. Ahmad)
        </div>
       </div>
       <div style="background: rgba(212, 175, 55, 0.1); padding: 6px; border-radius: 6px; border-left: 3px solid #d4af37;">
        <div style="opacity: 0.8; font-size: 15px; font-weight: 600; margin-bottom: 2px;">
         No. Rekening
        </div>
        <div style="font-weight: 700; font-size: 14px;">
         BSI 1234567890 a.n Masjid Al-Ikhlas
        </div>
       </div>
      </div>
     </div>
   </div><!-- Body Bawah (3 Kolom) -->
  <div style="padding: 0 24px 0 24px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; height: 100%; margin-top: -60px;"><!-- Donatur -->
    <div class="gold-border shadow-custom" style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 12px; height: calc(75% + 80px); min-height: 0; overflow: hidden; border: 2px solid #d4af37; display: flex; flex-direction: column;">
     <div style="font-size: 21.875px; font-weight: 700; color: #d4af37; margin-bottom: 2px; text-align: center; flex-shrink: 0;">
      DONATUR
     </div>
     <table style="width: 100%; font-size: 15.625px; flex-shrink: 0; margin-bottom: 4px; table-layout: fixed;">
      <thead>
       <tr style="border-bottom: 2px solid #d4af37;">
        <th style="padding: 2px; text-align: left; color: #d4af37; width: 65%;">Nama</th>
        <th style="padding: 2px; text-align: right; color: #d4af37; width: 35%;">Nominal</th>
       </tr>
      </thead>
     </table>
     <div id="donatur-scroll-container" style="overflow: hidden; position: relative; flex: 1;">
         <div id="donatur-scroll-content" style="position: absolute; width: 100%;">
             <table style="width: 100%; font-size: 15.625px; table-layout: fixed;">
              <tbody id="donatur-table">
               <tr class="table-row">
                <td style="padding: 2px; width: 65%;">Budi Santoso</td>
                <td style="padding: 2px; text-align: right; font-weight: 600; width: 35%;">Rp 500.000</td>
               </tr>
               <tr class="table-row">
                <td style="padding: 2px; width: 65%;">Siti Aminah</td>
                <td style="padding: 2px; text-align: right; font-weight: 600; width: 35%;">Rp 300.000</td>
               </tr>
               <tr class="table-row">
                <td style="padding: 2px; width: 65%;">Hamba Allah</td>
                <td style="padding: 2px; text-align: right; font-weight: 600; width: 35%;">Rp 1.000.000</td>
               </tr>
              </tbody>
             </table>
         </div>
     </div>
    </div><!-- Keuangan -->
    <div class="gold-border shadow-custom" style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 12px; height: calc(75% + 80px); min-height: 0; overflow: hidden; border: 2px solid #d4af37; display: flex; flex-direction: column;">
     <div style="font-size: 21.875px; font-weight: 700; color: #d4af37; margin-bottom: 2px; text-align: center; flex-shrink: 0;">
      KEUANGAN MASJID
     </div>
     <table style="width: 100%; font-size: 15.625px; flex-shrink: 0; margin-bottom: 4px; table-layout: fixed;">
      <thead>
       <tr style="border-bottom: 2px solid #d4af37;">
        <th style="padding: 2px; text-align: left; color: #d4af37; width: 60%;">Keterangan</th>
        <th style="padding: 2px; text-align: right; color: #d4af37; width: 40%;">Jumlah</th>
       </tr>
      </thead>
     </table>
     <div id="finance-scroll-container" style="overflow: hidden; position: relative; flex: 1;">
         <div id="finance-scroll-content" style="position: absolute; width: 100%;">
             <table style="width: 100%; font-size: 15.625px; table-layout: fixed;">
                 <tbody id="finance-table">
                   <tr class="table-row">
                    <td style="padding: 2px;">Penerimaan</td>
                    <td style="padding: 2px; text-align: right; font-weight: 600; color: #4ade80;">Rp 2.500.000</td>
                   </tr>
                   <tr class="table-row">
                    <td style="padding: 2px;">Pengeluaran</td>
                    <td style="padding: 2px; text-align: right; font-weight: 600; color: #f87171;">Rp 1.200.000</td>
                   </tr>
                   <tr style="border-top: 2px solid rgba(212, 175, 55, 0.05);">
                    <td style="padding: 2px; font-weight: 700;">Saldo</td>
                    <td style="padding: 2px; text-align: right; font-weight: 700; color: #d4af37;">Rp 1.300.000</td>
                   </tr>
                 </tbody>
             </table>
         </div>
     </div>
    </div><!-- Petugas -->
    <div class="gold-border shadow-custom" style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 12px; height: calc(75% + 80px); min-height: 0; overflow: hidden; border: 2px solid #d4af37;">
     <div style="font-size: 21.875px; font-weight: 700; color: #d4af37; margin-bottom: 2px; text-align: center;">
      PETUGAS SHOLAT
     </div>
     <table style="width: 100%; font-size: 14.0625px;">
      <thead>
       <tr style="border-bottom: 2px solid #d4af37;">
        <th style="padding: 2px; text-align: left; color: #d4af37;">Waktu</th>
        <th style="padding: 2px; text-align: left; color: #d4af37;">Imam</th>
        <th style="padding: 2px; text-align: left; color: #d4af37;">Muadzin</th>
       </tr>
      </thead>
      <tbody id="officer-table">
       <tr class="table-row">
        <td style="padding: 2px; font-weight: 700; color: #d4af37;">Subuh</td>
        <td style="padding: 2px;">Ust. Ahmad</td>
        <td style="padding: 2px;">Budi Santoso</td>
       </tr>
       <tr class="table-row">
        <td style="padding: 2px; font-weight: 700; color: #d4af37;">Dzuhur</td>
        <td style="padding: 2px;">Ust. Yusuf</td>
        <td style="padding: 2px;">Hasan Ali</td>
       </tr>
       <tr class="table-row">
        <td style="padding: 2px; font-weight: 700; color: #d4af37;">Ashar</td>
        <td style="padding: 2px;">Ust. Ibrahim</td>
        <td style="padding: 2px;">Faisal Rahman</td>
       </tr>
       <tr class="table-row">
        <td style="padding: 2px; font-weight: 700; color: #d4af37;">Maghrib</td>
        <td style="padding: 2px;">Ust. Umar</td>
        <td style="padding: 2px;">Ali Akbar</td>
       </tr>
       <tr class="table-row">
        <td style="padding: 2px; font-weight: 700; color: #d4af37;">Isya</td>
        <td style="padding: 2px;">Ust. Hamzah</td>
        <td style="padding: 2px;">Ridwan Hakim</td>
       </tr>
      </tbody>
     </table>
    </div>
   </div><!-- Modal Pengaturan -->
   <div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; overflow-y: auto;">
    <div style="max-width: 900px; margin: 40px auto; background: #1a4d2e; border: 3px solid #d4af37; border-radius: 20px; padding: 32px;">
     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 2px solid #d4af37; padding-bottom: 16px;">
      <h2 style="font-size: 28px; font-weight: 800; color: #d4af37; margin: 0;">⚙️ PANEL PENGATURAN ADMIN</h2><button id="close-modal-btn" style="background: rgba(248, 113, 113, 0.2); border: 2px solid #f87171; border-radius: 8px; padding: 8px 16px; color: #f87171; font-weight: 700; cursor: pointer;" onmouseover="this.style.background='#f87171'; this.style.color='white'" onmouseout="this.style.background='rgba(248, 113, 113, 0.2)'; this.style.color='#f87171'">✕ TUTUP</button>
     </div><!-- Tabs Navigation -->
     <div id="tabs-nav" style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap;"><button class="tab-btn" data-tab="identitas" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Identitas Masjid</button> <button class="tab-btn" data-tab="background" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Template Background</button> <button class="tab-btn" data-tab="waktu" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Waktu Sholat</button> <button class="tab-btn" data-tab="visibility" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Tampilan Waktu</button> <button class="tab-btn" data-tab="mode-pengumuman" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Mode Pengumuman</button> <button class="tab-btn" data-tab="pengumuman-text" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Edit Teks Pengumuman</button> <button class="tab-btn" data-tab="slideshow" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Slideshow Pengumuman</button> <button class="tab-btn" data-tab="info" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Info Masjid</button> <button class="tab-btn" data-tab="donatur" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Donatur</button> <button class="tab-btn" data-tab="keuangan" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Keuangan</button> <button class="tab-btn" data-tab="petugas" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Petugas Sholat</button> <button class="tab-btn" data-tab="takmir" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Foto Takmir</button> <button class="tab-btn" data-tab="audio" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Suara Adzan</button> <button class="tab-btn" data-tab="beep" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Beep Iqomah</button>
  <button class="tab-btn" data-tab="backup" style="background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid #d4af37; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;">Backup & Restore</button>
    </div><!-- Tab Content Container -->
     <div id="tab-content" style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 24px;"><!-- Content will be dynamically loaded here -->
     </div>
    </div>
   </div>
  </div>
  <script>
        const defaultConfig = {
            mosque_name: "MASJID AL-IKHLAS",
            mosque_address: "Jl. Contoh No. 123, Jakarta Selatan",
            announcement_title: "PENGUMUMAN MASJID",
            announcement_text: "Kajian rutin setiap hari Jumat pukul 19:30 WIB setelah sholat Maghrib. Mari hadir bersama untuk menambah ilmu agama kita.",
            primary_color: "#1a4d2e",
            gold_color: "#d4af37",
            text_color: "#ffffff",
            font_family: "Inter"
        };

        let prayerTimes = [
            { name: "Imsak", time: "04:30", visible: false },
            { name: "Subuh", time: "04:45", visible: true },
            { name: "Syuruq", time: "05:55", visible: false },
            { name: "Dhuha", time: "06:15", visible: false },
            { name: "Dzuhur", time: "12:05", visible: true },
            { name: "Ashar", time: "15:20", visible: true },
            { name: "Maghrib", time: "18:10", visible: true },
            { name: "Isya", time: "19:25", visible: true }
        ];

        let infoMasjidData = {
            capacity: "500 Jamaah",
            facilities: "AC, Parkir",
            iqomah: "15 Menit",
            contact: "0812-3456-7890",
            ramadhan: "Kajian Menjelang Berbuka",
            qurban: "Sapi: 3, Kambing: 15 (Panitia: Bpk. Ahmad)",
            rekening: "BSI 1234567890 a.n Masjid Al-Ikhlas"
        };

        let donatorsData = [
            { name: "Budi Santoso", amount: "500.000" },
            { name: "Siti Aminah", amount: "300.000" },
            { name: "Hamba Allah", amount: "1.000.000" },
            { name: "Ahmad Hidayat", amount: "250.000" },
            { name: "Nur Aisyah", amount: "150.000" }
        ];

        let prayerScheduleData = [];
        // Load data on startup
        try {
            const savedData = localStorage.getItem('prayerScheduleData');
            if (savedData) {
                prayerScheduleData = JSON.parse(savedData);
                // checkDailyUpdate will be called by updateClock or we can call it here if we trust hoisting
                // setTimeout(() => checkDailyUpdate(), 0); // Safe way
            }
        } catch (e) {
            console.error("Error loading schedule:", e);
        }

        let financeData = {
            income: "2.500.000",
            expense: "1.200.000",
            todayIncome: "500.000",
            weeklyIncome: "3.000.000",
            fridayIncome: "1.500.000",
            lastExpense: "200.000"
        };

        let officersData = [
            { prayer: "Subuh", imam: "Ust. Ahmad", muadzin: "Budi Santoso" },
            { prayer: "Dzuhur", imam: "Ust. Yusuf", muadzin: "Hasan Ali" },
            { prayer: "Ashar", imam: "Ust. Ibrahim", muadzin: "Faisal Rahman" },
            { prayer: "Maghrib", imam: "Ust. Umar", muadzin: "Ali Akbar" },
            { prayer: "Isya", imam: "Ust. Hamzah", muadzin: "Ridwan Hakim" }
        ];

        let takmirData = [
            { name: "H. Ahmad Yani", position: "Ketua Takmir", photoUrl: "" },
            { name: "H. Budi Santoso", position: "Sekretaris", photoUrl: "" },
            { name: "", position: "", photoUrl: "" },
            { name: "", position: "", photoUrl: "" }
        ];

        let leftColumnMode = 'takmir'; // 'takmir' or 'image'
        let leftColumnImageUrl = '';

        let slideshowData = [
            { imageUrl: "", caption: "Slide 1" },
            { imageUrl: "", caption: "Slide 2" },
            { imageUrl: "", caption: "Slide 3" },
            { imageUrl: "", caption: "Slide 4" },
            { imageUrl: "", caption: "Slide 5" }
        ];

        let backgroundSettings = {
            type: "gradient", // "solid", "gradient", or "image"
            solidColor: "#1a4d2e",
            gradientColor1: "#1a4d2e",
            gradientColor2: "#0d2818",
            gradientAngle: "135deg",
            imageUrl: "",
            imageOpacity: 0.3
        };

        let currentSlideIndex = 0;
        let slideshowInterval = null;

        let currentMosqueName = "MASJID AL-IKHLAS";
        let currentMosqueAddress = "Jl. Contoh No. 123, Jakarta Selatan";
        let currentAnnouncement = "Kajian rutin setiap hari Jumat pukul 19:30 WIB setelah sholat Maghrib. Mari hadir bersama untuk menambah ilmu agama kita.";
        
        let announcementMode = "text"; // "text" or "slideshow"
        let adzanAudioUrl = ""; // URL or data URL for adzan audio
        let adzanAudio = null; // Audio element
        let beepAudioUrl = ""; // URL or data URL for iqomah beep audio
        let beepAudio = null; // Beep audio element
        let adzanVolume = 1.0;
        let beepVolume = 1.0;
        let adzanMaxMinutes = 5;
        let adzanStopTimeout = null;
        let infoVisibilityConfig = { capacity: true, facilities: true, iqomah: true, contact: true, ramadhan: true, qurban: true, rekening: true };
        let infoAutoRotate = false;
        let infoRotateIntervalSec = 5;
        let infoRotateIndex = 0;
        let infoRotateTimer = null;
        let transparencyLevel = 0.2; // Default transparency

        // Centralized Storage Management
        const STORAGE_KEY = 'masjid_app_data_v1';

        function saveToLocalStorage() {
            const dataToSave = {
                prayerTimes,
                infoMasjidData,
                donatorsData,
                financeData,
                officersData,
                takmirData,
                leftColumnMode,
                leftColumnImageUrl,
                slideshowData,
                backgroundSettings,
                currentMosqueName,
                currentMosqueAddress,
                currentAnnouncement,
                announcementMode,
                adzanAudioUrl,
                beepAudioUrl,
                adzanVolume,
                beepVolume,
                adzanMaxMinutes,
                infoVisibilityConfig,
                infoAutoRotate,
                infoRotateIntervalSec,
                infoRotateIndex,
                transparencyLevel,
                prayerScheduleData
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                // Also save individual keys for backward compatibility or specific access if needed, 
                // but relying on one big object is safer for full restore.
                // However, prayerScheduleData was already using its own key, let's keep it sync.
                localStorage.setItem('prayerScheduleData', JSON.stringify(prayerScheduleData)); 
                console.log('Data saved successfully');
            } catch (e) {
                console.error('Failed to save data:', e);
                showNotification('⚠️ Gagal menyimpan data (Storage penuh?)');
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    
                    // Restore variable by variable if exists
                    if(parsed.prayerTimes) prayerTimes = parsed.prayerTimes;
                    if(parsed.infoMasjidData) infoMasjidData = { ...infoMasjidData, ...parsed.infoMasjidData };
                    if(parsed.donatorsData) donatorsData = parsed.donatorsData;
                    if(parsed.financeData) financeData = { ...financeData, ...parsed.financeData };
                    if(parsed.officersData) officersData = parsed.officersData;
                    if(parsed.takmirData) takmirData = parsed.takmirData;
                    if(parsed.leftColumnMode) leftColumnMode = parsed.leftColumnMode;
                    if(parsed.leftColumnImageUrl) leftColumnImageUrl = parsed.leftColumnImageUrl;
                    if(parsed.slideshowData) slideshowData = parsed.slideshowData;
                    if(parsed.backgroundSettings) backgroundSettings = parsed.backgroundSettings;
                    
                    if(parsed.currentMosqueName) currentMosqueName = parsed.currentMosqueName;
                    if(parsed.currentMosqueAddress) currentMosqueAddress = parsed.currentMosqueAddress;
                    if(parsed.currentAnnouncement) currentAnnouncement = parsed.currentAnnouncement;
                    if(parsed.announcementMode) announcementMode = parsed.announcementMode;
                    
                    if(parsed.adzanAudioUrl) adzanAudioUrl = parsed.adzanAudioUrl;
                    if(parsed.beepAudioUrl) beepAudioUrl = parsed.beepAudioUrl;
                    if(parsed.adzanVolume !== undefined) adzanVolume = parsed.adzanVolume;
                    if(parsed.beepVolume !== undefined) beepVolume = parsed.beepVolume;
                    if(parsed.adzanMaxMinutes !== undefined) adzanMaxMinutes = parsed.adzanMaxMinutes;
                    if(parsed.infoVisibilityConfig) infoVisibilityConfig = parsed.infoVisibilityConfig;
                    if(parsed.infoAutoRotate !== undefined) infoAutoRotate = parsed.infoAutoRotate;
                    if(parsed.infoRotateIntervalSec !== undefined) infoRotateIntervalSec = parsed.infoRotateIntervalSec;
                    if(parsed.infoRotateIndex !== undefined) infoRotateIndex = parsed.infoRotateIndex;
                    if(parsed.transparencyLevel) transparencyLevel = parsed.transparencyLevel;
                    
                    if(parsed.prayerScheduleData) prayerScheduleData = parsed.prayerScheduleData;
                    
                    console.log('Data restored successfully');
                } else {
                    // Try to load legacy prayerScheduleData if main storage not found
                    const legacySchedule = localStorage.getItem('prayerScheduleData');
                    if (legacySchedule) {
                        prayerScheduleData = JSON.parse(legacySchedule);
                    }
                }
            } catch (e) {
                console.error('Failed to load data:', e);
            }
        }

        // Initialize Data
        loadFromLocalStorage();
        let lastCheckedDateStr = "";

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds}`;
            
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const dayName = days[now.getDay()];
            const date = now.getDate();
            const monthName = months[now.getMonth()];
            const year = now.getFullYear();
            
            // Hijri Date
            let hijriDate = "";
            try {
                hijriDate = new Intl.DateTimeFormat('id-ID', { calendar: 'islamic-umalqura', day: 'numeric', month: 'long', year: 'numeric' }).format(now);
            } catch (e) {
                // Fallback if islamic-umalqura is not supported
                hijriDate = new Intl.DateTimeFormat('id-ID', { calendar: 'islamic', day: 'numeric', month: 'long', year: 'numeric' }).format(now);
            }
            
            // Remove "tahun" word if present and ensure "H" is not doubled if the format already includes it
            hijriDate = hijriDate.replace('tahun', '').trim();
            if (hijriDate.endsWith(' H')) {
                 hijriDate = hijriDate.substring(0, hijriDate.length - 2);
            }

            document.getElementById('current-date').textContent = `${dayName}, ${date} ${monthName} ${year} M / ${hijriDate} H`;

            // Check for daily update if date changed
            const currentDateStr = now.toDateString();
            if (lastCheckedDateStr !== currentDateStr) {
                lastCheckedDateStr = currentDateStr;
                if (typeof checkDailyUpdate === 'function') {
                    checkDailyUpdate();
                }
            }
        }

        function findNextPrayer() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // Helper to check visibility with backward compatibility
            const isVisible = (p) => {
                if (p.visible !== undefined) return p.visible;
                // Fallback for old data: hide specific non-obligatory times
                return !["Imsak", "Syuruq", "Dhuha"].includes(p.name);
            };

            // Helper to parse time string safely
            const parseTime = (timeStr) => {
                if (!timeStr || typeof timeStr !== 'string') return null;
                // Handle HH:MM or HH.MM
                const parts = timeStr.replace('.', ':').split(':');
                if (parts.length < 2) return null;
                const h = parseInt(parts[0]);
                const m = parseInt(parts[1]);
                if (isNaN(h) || isNaN(m)) return null;
                return [h, m];
            };

            // Find next VISIBLE prayer today
            for (let i = 0; i < prayerTimes.length; i++) {
                if (!prayerTimes[i] || !isVisible(prayerTimes[i])) continue;

                const timeParts = parseTime(prayerTimes[i].time);
                if (!timeParts) continue;

                const [hours, minutes] = timeParts;
                const prayerMinutes = hours * 60 + minutes;
                
                if (currentTime < prayerMinutes) {
                    return i;
                }
            }
            
            // If no visible prayer left today, return first visible prayer (for tomorrow)
            for (let i = 0; i < prayerTimes.length; i++) {
                if (prayerTimes[i] && isVisible(prayerTimes[i])) return i;
            }
            
            return 0;
        }

        let isAdzanTime = false;
        let adzanPrayerName = "";
        let adzanCheckTimeout = null;
        let isIqomahCountdown = false;
        let iqomahPrayerName = "";
        let iqomahMinutesLeft = 0;

        function updateCountdown() {
            try {
                const now = new Date();
                const nextPrayerIndex = findNextPrayer();
                // Ensure nextPrayerIndex is valid
                if (nextPrayerIndex < 0 || !prayerTimes[nextPrayerIndex]) return;

                const nextPrayer = prayerTimes[nextPrayerIndex];
                
                let prayerName = nextPrayer.name ? nextPrayer.name.toUpperCase() : "SHOLAT";
                // Change "DZUHUR" to "JUMAT" if it's Friday
                if (now.getDay() === 5 && prayerName === 'DZUHUR') {
                    prayerName = 'JUMAT';
                }
                const nameEl = document.getElementById('next-prayer-name');
                if (nameEl) nameEl.textContent = prayerName;
                
                // Safe time parsing
                let hours, minutes;
                if (nextPrayer.time && typeof nextPrayer.time === 'string') {
                    const parts = nextPrayer.time.replace('.', ':').split(':');
                    if (parts.length >= 2) {
                        hours = parseInt(parts[0]);
                        minutes = parseInt(parts[1]);
                    }
                }

                if (isNaN(hours) || isNaN(minutes)) {
                    return; // Skip if invalid time
                }

                let targetTime = new Date();
                targetTime.setHours(hours, minutes, 0, 0);
                
                // If target time is in the past, it must be for tomorrow
                // But wait, findNextPrayer logic handles "next visible".
                // If findNextPrayer returns today's prayer, it means currentTime < prayerMinutes.
                // So targetTime should be > now.
                // However, with seconds involved, targetTime (00s) might be < now (30s).
                // In that case, it's actually "tomorrow" only if findNextPrayer returned tomorrow's prayer.
                // But findNextPrayer returns based on HH:MM.
                // If 12:05 < 12:05 (False) -> returns Ashar.
                // If 12:04 < 12:05 (True) -> returns Dzuhur.
                // If now is 12:04:59. targetTime 12:05:00. diff > 0.
                // If now is 12:05:01. findNextPrayer should return Ashar.
                // So targetTime < now shouldn't happen for "today's" prayer usually.
                // EXCEPT if findNextPrayer wrapped around to tomorrow.
                
                // Logic:
                // If targetTime < now, assume it's tomorrow?
                // If findNextPrayer returned a prayer index < current time index?
                // No, findNextPrayer is stateless.
                
                // Let's keep the existing logic: if targetTime < now, add 1 day.
                // This covers the wrap-around case (next prayer is Subuh tomorrow).
                // It also covers the edge case where now > targetTime by seconds (e.g. 12:05:01 vs 12:05:00), 
                // effectively treating it as tomorrow's prayer? 
                // NO! If it's 12:05:01, findNextPrayer should have returned Ashar.
                // So targetTime would be 15:20. 15:20 > 12:05.
                // So the only case targetTime < now is if it's tomorrow's prayer (e.g. Subuh 04:45 vs now 20:00).
                
                if (targetTime < now) {
                    targetTime.setDate(targetTime.getDate() + 1);
                }
                
                const diff = targetTime - now;
                const totalSeconds = Math.floor(Math.max(0, diff) / 1000);
                
                const hoursLeft = Math.floor(totalSeconds / 3600);
                const minutesLeft = Math.floor((totalSeconds % 3600) / 60);
                const secondsLeft = totalSeconds % 60;
                
                const countdownEl = document.getElementById('countdown');
                if (countdownEl) {
                    countdownEl.textContent = 
                        `${String(hoursLeft).padStart(2, '0')}:${String(minutesLeft).padStart(2, '0')}:${String(secondsLeft).padStart(2, '0')}`;
                }
                
                // Check if it's adzan time (within 5 minutes of prayer time)
                checkAdzanTime();
            } catch (e) {
                console.error("Countdown error:", e);
            }
        }

        function checkAdzanTime() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            let foundAdzanTime = false;
            let foundIqomahTime = false;
            
            for (let prayer of prayerTimes) {
                if (!prayer || !prayer.name) continue;

                // Skip Imsak, Syuruq, and Dhuha - they don't have adzan
                if (prayer.name === "Imsak" || prayer.name === "Syuruq" || prayer.name === "Dhuha") {
                    continue;
                }
                
                // Safe parsing
                let hours, minutes;
                if (prayer.time && typeof prayer.time === 'string') {
                    const parts = prayer.time.replace('.', ':').split(':');
                    if (parts.length >= 2) {
                        hours = parseInt(parts[0]);
                        minutes = parseInt(parts[1]);
                    }
                }
                
                if (isNaN(hours) || isNaN(minutes)) continue;

                const prayerMinutes = hours * 60 + minutes;
                
                // Check if current time is within 5 minutes after prayer time (ADZAN)
                if (currentMinutes >= prayerMinutes && currentMinutes < prayerMinutes + 5) {
                    if (!isAdzanTime || adzanPrayerName !== prayer.name) {
                        isAdzanTime = true;
                        isIqomahCountdown = false;
                        adzanPrayerName = prayer.name;
                        showAdzanNotification();
                    }
                    foundAdzanTime = true;
                    break;
                }
                
                // Check if current time is 5-15 minutes after prayer time (IQOMAH COUNTDOWN)
                if (currentMinutes >= prayerMinutes + 5 && currentMinutes < prayerMinutes + 15) {
                    const minutesLeft = 15 - (currentMinutes - prayerMinutes);
                    if (!isIqomahCountdown || iqomahPrayerName !== prayer.name) {
                        isAdzanTime = false;
                        isIqomahCountdown = true;
                        iqomahPrayerName = prayer.name;
                        iqomahMinutesLeft = minutesLeft;
                        showIqomahNotification();
                    } else {
                        iqomahMinutesLeft = minutesLeft;
                        updateIqomahCountdown();
                    }
                    foundIqomahTime = true;
                    break;
                }
            }
            
            if (!foundAdzanTime && !foundIqomahTime && (isAdzanTime || isIqomahCountdown)) {
                // Both adzan and iqomah time have passed, restore normal display
                isAdzanTime = false;
                isIqomahCountdown = false;
                adzanPrayerName = "";
                iqomahPrayerName = "";
                hideAdzanNotification();
            }
        }

        function showAdzanNotification() {
            const textContainer = document.getElementById('text-announcement-container');
            const slideshowContainer = document.getElementById('slideshow-container');
            const announcementTitleContainer = document.getElementById('announcement-title-container');
            
            // Stop slideshow if running
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
            }
            
            // Play adzan audio if available
            if (adzanAudioUrl) {
                if (adzanAudio) {
                    adzanAudio.pause();
                    adzanAudio.currentTime = 0;
                }
                adzanAudio = new Audio(adzanAudioUrl);
                adzanAudio.volume = Math.max(0, Math.min(1, adzanVolume));
                adzanAudio.play().catch(err => {
                    console.error('Error playing adzan audio:', err);
                });
                if (adzanStopTimeout) {
                    clearTimeout(adzanStopTimeout);
                    adzanStopTimeout = null;
                }
                adzanStopTimeout = setTimeout(() => {
                    if (adzanAudio) {
                        adzanAudio.pause();
                        adzanAudio.currentTime = 0;
                    }
                }, Math.max(1, parseInt(adzanMaxMinutes)) * 60 * 1000);
            }
            
            // Hide everything and show adzan message
            textContainer.style.display = 'none';
            slideshowContainer.style.display = 'flex';
            announcementTitleContainer.style.display = 'none';
            document.getElementById('slide-dots').style.display = 'none';
            
            slideshowContainer.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a4d2e 0%, #0d2818 100%); padding: 40px; text-align: center;">
                    <div style="font-size: 32px; font-weight: 800; color: #d4af37; margin-bottom: 4px; letter-spacing: 2px;">SAATNYA ADZAN</div>
                    <div style="font-size: 48px; font-weight: 900; color: white; margin-bottom: 6px; text-shadow: 0 4px 20px rgba(212, 175, 55, 0.5);">${adzanPrayerName.toUpperCase()}</div>
                    <div style="font-size: 18px; color: #d4af37; margin-bottom: 8px; opacity: 0.9;">Mari segera menuju masjid untuk menunaikan sholat berjamaah</div>
                    <div style="width: 80%; height: 3px; background: linear-gradient(90deg, transparent, #d4af37, transparent); margin: 6px 0;"></div>
                    <div style="font-size: 14px; color: white; opacity: 0.8; font-style: italic;">"Dan dirikanlah sholat, sesungguhnya sholat itu mencegah dari perbuatan keji dan mungkar" (QS. Al-Ankabut: 45)</div>
                    ${adzanAudioUrl ? '<div style="margin-top: 12px; color: #d4af37; font-size: 16px;">     Suara Adzan Sedang Diputar</div>' : ''}
                </div>
            `;
        }

        function showIqomahNotification() {
            const textContainer = document.getElementById('text-announcement-container');
            const slideshowContainer = document.getElementById('slideshow-container');
            const announcementTitleContainer = document.getElementById('announcement-title-container');
            
            // Stop slideshow if running
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
            }
            
            // Stop adzan audio if playing and play beep audio
            if (adzanAudio) {
                adzanAudio.pause();
                adzanAudio.currentTime = 0;
            }
            if (adzanStopTimeout) {
                clearTimeout(adzanStopTimeout);
                adzanStopTimeout = null;
            }
            
            // Play beep audio if available
            if (beepAudioUrl) {
                if (beepAudio) {
                    beepAudio.pause();
                    beepAudio.currentTime = 0;
                }
                beepAudio = new Audio(beepAudioUrl);
                beepAudio.volume = Math.max(0, Math.min(1, beepVolume));
                beepAudio.play().catch(err => {
                    console.error('Error playing beep audio:', err);
                });
            }
            
            // Hide everything and show iqomah countdown message
            textContainer.style.display = 'none';
            slideshowContainer.style.display = 'flex';
            announcementTitleContainer.style.display = 'none';
            document.getElementById('slide-dots').style.display = 'none';
            
            slideshowContainer.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #0d2818 0%, #1a4d2e 100%); padding: 40px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 800; color: #d4af37; margin-bottom: 4px; letter-spacing: 2px;">⏰ BERSIAP-SIAPLAH</div>
                    <div id="iqomah-countdown-display" style="font-size: 56px; font-weight: 900; color: white; margin-bottom: 4px; text-shadow: 0 4px 20px rgba(212, 175, 55, 0.5);">${iqomahMinutesLeft} MENIT</div>
                    <div style="font-size: 24px; color: #d4af37; margin-bottom: 6px; opacity: 0.9;">MENUJU IQOMAH ${iqomahPrayerName.toUpperCase()}</div>
                    <div style="width: 80%; height: 3px; background: linear-gradient(90deg, transparent, #d4af37, transparent); margin: 6px 0;"></div>
                    <div style="font-size: 16px; color: white; opacity: 0.9; font-weight: 600; margin-top: 4px;">Mari segera menuju shaf untuk berjamaah</div>
                    ${beepAudioUrl ? '<div style="margin-top: 12px; color: #d4af37; font-size: 16px;">🔔 Bunyi Beep Iqomah</div>' : ''}
                </div>
            `;
        }

        function updateIqomahCountdown() {
            const countdownDisplay = document.getElementById('iqomah-countdown-display');
            if (countdownDisplay) {
                countdownDisplay.textContent = `${iqomahMinutesLeft} MENIT`;
            }
        }

        function hideAdzanNotification() {
            // Stop adzan audio if playing
            if (adzanAudio) {
                adzanAudio.pause();
                adzanAudio.currentTime = 0;
            }
            if (adzanStopTimeout) {
                clearTimeout(adzanStopTimeout);
                adzanStopTimeout = null;
            }
            
            // Restore the original announcement display
            updateAnnouncementDisplay();
        }

        function renderPrayerCards() {
            const container = document.getElementById('prayer-cards');
            const nextPrayerIndex = findNextPrayer();
            
            // Filter only visible prayers
            const visiblePrayers = prayerTimes.filter(prayer => prayer.visible);
            const columnCount = visiblePrayers.length;
            
            // Update grid to fit visible prayers
            container.style.gridTemplateColumns = `repeat(${columnCount}, 1fr)`;
            
            container.innerHTML = prayerTimes.filter(prayer => prayer.visible).map((prayer, displayIndex) => {
                // Find original index for proper "next prayer" detection
                const originalIndex = prayerTimes.findIndex(p => p.name === prayer.name);
                const isActive = originalIndex === nextPrayerIndex;
                const cardClass = isActive ? 'active-prayer' : 'gold-border';
                const textColor = isActive ? '#1a4d2e' : '#ffffff';
                const timeColor = isActive ? '#1a4d2e' : '#d4af37';
                const borderStyle = isActive ? '' : `border: 2px solid rgba(212, 175, 55, ${transparencyLevel});`;
                
                // Display name with Friday adjustment
                const now = new Date();
                let displayName = (prayer.name || '').toUpperCase();
                if (now.getDay() === 5 && displayName === 'DZUHUR') {
                    displayName = 'JUMAT';
                }
                
                return `
                    <div class="prayer-card shadow-custom ${cardClass} ${isActive ? 'soft-pulse-1s' : ''}" style="background: ${isActive ? '' : 'rgba(255, 255, 255, 0.05)'}; ${borderStyle} border-radius: 10px; padding: 12px; text-align: center;">
                        <div style="font-size: 13px; font-weight: 700; color: ${textColor}; margin-bottom: 6px;">${displayName}</div>
                        <div style="font-size: 28px; font-weight: 800; color: ${timeColor};">${prayer.time}</div>
                    </div>
                `;
            }).join('');
        }

        function updateTakmirDisplay() {
            const leftCol1 = document.getElementById('left-col-1');
            const leftCol2 = document.getElementById('left-col-2');
            const mainGrid = document.getElementById('main-content-grid');
            
            // Handle Left Column Mode
            if (typeof leftColumnMode !== 'undefined' && leftColumnMode === 'image') {
                if (mainGrid) {
                    mainGrid.style.gridTemplateColumns = '1.5fr 2.8fr 0.75fr';
                }
                if (leftCol2) {
                    leftCol2.style.display = 'none';
                }
                if (leftCol1) {
                    leftCol1.innerHTML = `
                        <div style="background: transparent; border-radius: 12px; padding: 0; text-align: center; border: none; box-shadow: none; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            ${leftColumnImageUrl ? `<img src="${leftColumnImageUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : '<div style="color: rgba(255,255,255,0.5);">Belum ada gambar</div>'}
                        </div>
                    `;
                }
            } else {
                // Restore structure
                if (mainGrid) {
                    mainGrid.style.gridTemplateColumns = '0.75fr 0.75fr 2.8fr 0.75fr';
                }
                if (leftCol2) {
                    leftCol2.style.display = 'flex';
                }
                if (leftCol1 && !leftCol1.querySelector('#takmir-display-1')) {
                    leftCol1.innerHTML = `
                        <div style="background: transparent; border: none; padding: 0; flex: 1.3; display: flex; flex-direction: column; justify-content: center; box-shadow: none !important; -webkit-box-shadow: none !important; overflow: hidden; min-height: 0;">
                            <div id="takmir-display-1" style="display: flex; flex-direction: column; gap: 10px; height: 100%;"></div>
                        </div>
                        <div id="takmir-display-3" style="flex: 0.7; display: flex; flex-direction: column; gap: 10px; justify-content: flex-start; align-items: center; width: 100%; height: 100%;"></div>
                    `;
                }
            }

            const container1 = document.getElementById('takmir-display-1');
            const container2 = document.getElementById('takmir-display-2');
            const container3 = document.getElementById('takmir-display-3');
            const container4 = document.getElementById('takmir-display-4');
            
            // Allow display if name OR photo exists
            const activeTakmir = takmirData.filter(t => t.name.trim() !== '' || t.photoUrl.trim() !== '');
            
            if (activeTakmir.length === 0) {
                if(container1) container1.innerHTML = '';
                if(container2) container2.innerHTML = '';
                if(container3) container3.innerHTML = '';
                if(container4) container4.innerHTML = '';
                return;
            }
            
            const firstTakmir = activeTakmir[0] || null;
            const secondTakmir = activeTakmir[1] || null;
            const thirdTakmir = activeTakmir[2] || null;
            const fourthTakmir = activeTakmir[3] || null;
            
            // Row 1 Style (No Icon Style, No Name/Position, No Box, Remove Black Background)
            const takmirHTMLRow1 = (takmir) => {
                if (!takmir.photoUrl || takmir.photoUrl.trim() === '') return '';
                return `<img src="${takmir.photoUrl}" style="width: 5cm; height: 5cm; object-fit: contain; mix-blend-mode: screen; border: none; outline: none; background: transparent; display: block; box-shadow: none !important; -webkit-box-shadow: none !important; filter: none !important; margin: 0 auto; align-self: center;" alt="${takmir.name}" onerror="this.style.display='none';">`;
            };

            const takmirHTMLRow2 = (takmir) => `
                <div style="display: flex; flex-direction: column; gap: 8px; align-items: center; width: 100%; height: 100%; justify-content: flex-start;">
                    ${takmir.photoUrl && takmir.photoUrl.trim() !== '' ? `
                        <div style="width: 5.2cm; height: 5.2cm; padding: 6px; border-radius: 16px; background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(255, 255, 255, 0.06) 100%); border: 3px solid #d4af37; box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35); display: flex; align-items: center; justify-content: center;">
                            <img src="${takmir.photoUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px; display: block;" alt="${takmir.name}" onerror="this.parentElement.style.display='none';">
                        </div>
                    ` : ''}
                    <div style="text-align: center; width: 100%;">
                        <div style="font-size: 15.625px; font-weight: 700; color: #d4af37; margin-bottom: 2px;">${takmir.name}</div>
                        <div style="font-size: 12.5px; color: white; opacity: 0.8;">${takmir.position}</div>
                    </div>
                </div>
            `;
            
            if(container1) container1.innerHTML = firstTakmir ? takmirHTMLRow1(firstTakmir) : '';
            if(container2) container2.innerHTML = secondTakmir ? takmirHTMLRow1(secondTakmir) : '';
            if(container3) container3.innerHTML = thirdTakmir ? takmirHTMLRow2(thirdTakmir) : '';
            if(container4) container4.innerHTML = fourthTakmir ? takmirHTMLRow2(fourthTakmir) : '';
        }

        function renderSlideshow() {
            const container = document.getElementById('slideshow-container');
            const dotsContainer = document.getElementById('slide-dots');
            
            // Filter active slides (with images)
            const activeSlides = slideshowData.filter(s => s.imageUrl && s.imageUrl.trim() !== '');
            
            if (activeSlides.length === 0) {
                container.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: rgba(255, 255, 255, 0.5); font-size: 16px; gap: 12px;"><svg style="width: 64px; height: 64px; color: #d4af37;" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/></svg><div>Belum ada gambar pengumuman</div><div style="font-size: 12px; opacity: 0.7;">Klik tombol Settings untuk menambahkan gambar</div></div>';
                dotsContainer.innerHTML = '';
                return;
            }
            
            // Render slides
            container.innerHTML = activeSlides.map((slide, index) => `
                <div class="slide" style="display: ${index === currentSlideIndex ? 'flex' : 'none'}; position: absolute; inset: 0; width: 100%; height: 100%; align-items: center; justify-content: center;">
                    <img src="${slide.imageUrl}" style="width: 100%; height: 100%; object-fit: cover; animation: fadeIn 1500ms ease-in-out both;" alt="${slide.caption}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="display: none; flex-direction: column; align-items: center; justify-content: center; gap: 12px;">
                        <svg style="width: 64px; height: 64px; color: #d4af37;" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/></svg>
                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 16px;">Gagal memuat gambar</div>
                        <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px;">Periksa URL gambar di Settings</div>
                    </div>
                </div>
            `).join('');
            
            // Render dots
            dotsContainer.innerHTML = activeSlides.map((_, index) => `
                <div class="slide-dot" onclick="goToSlide(${index})" style="width: 12px; height: 12px; border-radius: 50%; background: ${index === currentSlideIndex ? '#d4af37' : 'rgba(255, 255, 255, 0.3)'}; cursor: pointer; transition: all 0.3s;"></div>
            `).join('');
        }

        function updateAnnouncementDisplay() {
            const textContainer = document.getElementById('text-announcement-container');
            const slideshowContainer = document.getElementById('slideshow-container');
            const dotsContainer = document.getElementById('slide-dots');
            const announcementTitleContainer = document.getElementById('announcement-title-container');
            
            if (announcementMode === "text") {
                textContainer.style.display = 'flex';
                slideshowContainer.style.display = 'none';
                dotsContainer.style.display = 'none';
                announcementTitleContainer.style.display = 'flex';
                if (slideshowInterval) {
                    clearInterval(slideshowInterval);
                    slideshowInterval = null;
                }
            } else {
                textContainer.style.display = 'none';
                slideshowContainer.style.display = 'block';
                dotsContainer.style.display = 'flex';
                announcementTitleContainer.style.display = 'none';
                currentSlideIndex = 0;
                renderSlideshow();
                startSlideshow();
            }
        }

        function nextSlide() {
            const activeSlides = slideshowData.filter(s => s.imageUrl && s.imageUrl.trim() !== '');
            if (activeSlides.length === 0) return;
            
            currentSlideIndex = (currentSlideIndex + 1) % activeSlides.length;
            renderSlideshow();
        }

        window.goToSlide = function(index) {
            currentSlideIndex = index;
            renderSlideshow();
        };

        function startSlideshow() {
            if (slideshowInterval) clearInterval(slideshowInterval);
            slideshowInterval = setInterval(nextSlide, 10000);
        }

        async function onConfigChange(config) {
            const mosqueNameEl = document.getElementById('mosque-name');
            const mosqueAddressEl = document.getElementById('mosque-address');
            const announcementTitleEl = document.getElementById('announcement-title');
            const announcementTextEl = document.getElementById('announcement-text');
            
            mosqueNameEl.textContent = config.mosque_name || defaultConfig.mosque_name;
            mosqueAddressEl.textContent = config.mosque_address || defaultConfig.mosque_address;
            announcementTitleEl.textContent = config.announcement_title || defaultConfig.announcement_title;
            announcementTextEl.textContent = config.announcement_text || defaultConfig.announcement_text;
            
            const customFont = config.font_family || defaultConfig.font_family;
            const baseFontStack = 'Inter, sans-serif';
            document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
        }

        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: defaultConfig,
                onConfigChange: onConfigChange,
                mapToCapabilities: (config) => ({
                    recolorables: [
                        {
                            get: () => config.primary_color || defaultConfig.primary_color,
                            set: (value) => {
                                config.primary_color = value;
                                window.elementSdk.setConfig({ primary_color: value });
                            }
                        },
                        {
                            get: () => config.gold_color || defaultConfig.gold_color,
                            set: (value) => {
                                config.gold_color = value;
                                window.elementSdk.setConfig({ gold_color: value });
                            }
                        },
                        {
                            get: () => config.text_color || defaultConfig.text_color,
                            set: (value) => {
                                config.text_color = value;
                                window.elementSdk.setConfig({ text_color: value });
                            }
                        }
                    ],
                    borderables: [],
                    fontEditable: {
                        get: () => config.font_family || defaultConfig.font_family,
                        set: (value) => {
                            config.font_family = value;
                            window.elementSdk.setConfig({ font_family: value });
                        }
                    },
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["mosque_name", config.mosque_name || defaultConfig.mosque_name],
                    ["mosque_address", config.mosque_address || defaultConfig.mosque_address],
                    ["announcement_title", config.announcement_title || defaultConfig.announcement_title],
                    ["announcement_text", config.announcement_text || defaultConfig.announcement_text]
                ])
            });
        }

        // Initialize
        /*
        updateClock();
        updateCountdown();
        renderPrayerCards();
        updateTakmirDisplay();
        updateAnnouncementDisplay();
        updateInfoDisplay();
        updateDonaturDisplay();
        updateFinanceDisplay();
        updateOfficersDisplay();
        updateAllTransparency();
        
        // Update every second
        setInterval(() => {
            updateClock();
            updateCountdown();
            renderPrayerCards();
        }, 1000);
        */

        // Settings Modal Functions - Moved to ensure DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const settingsModal = document.getElementById('settings-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const openSettingsBtn = document.getElementById('open-settings-btn');
            
            if (openSettingsBtn) {
                openSettingsBtn.addEventListener('click', () => {
                    settingsModal.style.display = 'block';
                    showTab('identitas');
                });
            }

            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    settingsModal.style.display = 'none';
                });
            }

            // Also attach to tab buttons here to be safe
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.getAttribute('data-tab');
                    
                    // Update button styles
                    tabButtons.forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.1)';
                        b.style.color = 'white';
                        b.style.border = '2px solid #d4af37';
                    });
                    btn.style.background = '#d4af37';
                    btn.style.color = '#1a4d2e';
                    btn.style.border = 'none';
                    
                    showTab(tabName);
                });
            });
        });

        function showTab(tabName) {
            const tabContent = document.getElementById('tab-content');
            
            switch(tabName) {
                case 'identitas':
                    tabContent.innerHTML = renderIdentitasTab();
                    break;
                case 'background':
                    tabContent.innerHTML = renderBackgroundTab();
                    attachBackgroundEventListeners();
                    break;
                case 'waktu':
                    tabContent.innerHTML = renderWaktuTab();
                    attachWaktuEventListeners();
                    break;
                case 'visibility':
                    tabContent.innerHTML = renderVisibilityTab();
                    attachVisibilityEventListeners();
                    break;
                case 'mode-pengumuman':
                    tabContent.innerHTML = renderModePengumumanTab();
                    attachModePengumumanEventListeners();
                    break;
                case 'pengumuman-text':
                    tabContent.innerHTML = renderPengumumanTab();
                    attachPengumumanEventListeners();
                    break;
                case 'slideshow':
                    tabContent.innerHTML = renderSlideshowTab();
                    attachSlideshowEventListeners();
                    break;
                case 'info':
                    tabContent.innerHTML = renderInfoTab();
                    attachInfoEventListeners();
                    break;
                case 'donatur':
                    tabContent.innerHTML = renderDonaturTab();
                    attachDonaturEventListeners();
                    break;
                case 'keuangan':
                    tabContent.innerHTML = renderKeuanganTab();
                    attachKeuanganEventListeners();
                    break;
                case 'petugas':
                    tabContent.innerHTML = renderPetugasTab();
                    attachPetugasEventListeners();
                    break;
                case 'takmir':
                    tabContent.innerHTML = renderTakmirTab();
                    attachTakmirEventListeners();
                    break;
                case 'audio':
                    tabContent.innerHTML = renderAudioTab();
                    attachAudioEventListeners();
                    break;
                case 'beep':
                    tabContent.innerHTML = renderBeepTab();
                    attachBeepEventListeners();
                    break;
                case 'backup':
                    tabContent.innerHTML = renderBackupTab();
                    attachBackupEventListeners();
                    break;
            }
        }

        function renderBackupTab() {
            return `
                <h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">💾 Backup & Restore Data</h3>
                
                <div style="background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 12px; border: 2px solid #d4af37; margin-bottom: 24px;">
                    <h4 style="color: white; font-size: 16px; margin-bottom: 12px; font-weight: 700;">⬇️ Download Backup Data</h4>
                    <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 16px;">
                        Simpan semua pengaturan, jadwal, dan data masjid ke dalam satu file. Aman untuk dipindahkan ke komputer lain.
                    </p>
                    <button onclick="downloadBackup()" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer;">
                        💾 DOWNLOAD DATA BACKUP
                    </button>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; border: 2px dashed rgba(212, 175, 55, 0.5);">
                    <h4 style="color: #d4af37; font-size: 16px; margin-bottom: 12px; font-weight: 700;">⬆️ Restore Data dari File</h4>
                    <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 16px;">
                        Kembalikan pengaturan dari file backup yang sudah disimpan sebelumnya.
                    </p>
                    <input type="file" id="restore-upload" accept=".json" style="display: none;" onchange="handleRestoreUpload(event)">
                    <button onclick="document.getElementById('restore-upload').click()" style="background: rgba(212, 175, 55, 0.2); color: #d4af37; border: 2px solid #d4af37; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer;">
                        📂 PILIH FILE BACKUP
                    </button>
                </div>
            `;
        }

        function attachBackupEventListeners() {
            // Handled by inline onclick
        }

        window.downloadBackup = function() {
            const dataToSave = {
                prayerTimes,
                infoMasjidData,
                donatorsData,
                financeData,
                officersData,
                takmirData,
                leftColumnMode,
                leftColumnImageUrl,
                slideshowData,
                backgroundSettings,
                currentMosqueName,
                currentMosqueAddress,
                currentAnnouncement,
                announcementMode,
                adzanAudioUrl,
                beepAudioUrl,
                adzanVolume,
                beepVolume,
                transparencyLevel,
                prayerScheduleData,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToSave, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const date = new Date().toISOString().slice(0,10);
            downloadAnchorNode.setAttribute("download", `backup_masjid_${date}.json`);
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            showNotification('✅ Data berhasil didownload!');
        };

        window.handleRestoreUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    // Validate basic structure
                    if (!json.prayerTimes && !json.infoMasjidData) {
                        alert("File backup tidak valid!");
                        return;
                    }

                    if (confirm("Apakah Anda yakin ingin merestore data ini? Semua pengaturan saat ini akan digantikan.")) {
                        // Restore to variables
                        if(json.prayerTimes) prayerTimes = json.prayerTimes;
                        if(json.infoMasjidData) infoMasjidData = { ...infoMasjidData, ...json.infoMasjidData };
                        if(json.donatorsData) donatorsData = json.donatorsData;
                        if(json.financeData) financeData = { ...financeData, ...json.financeData };
                        if(json.officersData) officersData = json.officersData;
                        if(json.takmirData) takmirData = json.takmirData;
                        if(json.leftColumnMode) leftColumnMode = json.leftColumnMode;
                        if(json.leftColumnImageUrl) leftColumnImageUrl = json.leftColumnImageUrl;
                        if(json.slideshowData) slideshowData = json.slideshowData;
                        if(json.backgroundSettings) backgroundSettings = json.backgroundSettings;
                        
                        if(json.currentMosqueName) currentMosqueName = json.currentMosqueName;
                        if(json.currentMosqueAddress) currentMosqueAddress = json.currentMosqueAddress;
                        if(json.currentAnnouncement) currentAnnouncement = json.currentAnnouncement;
                        if(json.announcementMode) announcementMode = json.announcementMode;
                        
                        if(json.adzanAudioUrl) adzanAudioUrl = json.adzanAudioUrl;
                        if(json.beepAudioUrl) beepAudioUrl = json.beepAudioUrl;
                        if(json.adzanVolume !== undefined) adzanVolume = json.adzanVolume;
                        if(json.beepVolume !== undefined) beepVolume = json.beepVolume;
                        if(json.transparencyLevel) transparencyLevel = json.transparencyLevel;
                        
                        if(json.prayerScheduleData) prayerScheduleData = json.prayerScheduleData;

                        // Save to localStorage immediately
                        saveToLocalStorage();
                        
                        showNotification('✅ Data berhasil direstore! Memuat ulang...');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    }
                } catch (err) {
                    console.error(err);
                    alert("Gagal membaca file backup. Pastikan file JSON valid.");
                }
            };
            reader.readAsText(file);
        };

        function renderIdentitasTab() {
            return `
                <h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">✏️ Edit Identitas Masjid</h3>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Nama Masjid:</label>
                        <input type="text" id="edit-mosque-name" value="${currentMosqueName}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Alamat Masjid:</label>
                        <input type="text" id="edit-mosque-address" value="${currentMosqueAddress}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <button onclick="saveIdentitas()" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer; margin-top: 8px;">    SIMPAN PERUBAHAN</button>
                </div>
            `;
        }

        function renderBackgroundTab() {
            return `
                <h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">🎨 Pilih Template Background</h3>
                <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 20px;">
                    Pilih jenis background yang ingin ditampilkan di layar utama:
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                    <!-- Solid Color -->
                    <div onclick="selectBackgroundType('solid')" style="background: ${backgroundSettings.type === 'solid' ? 'linear-gradient(135deg, #d4af37 0%, #c9a636 100%)' : 'rgba(255, 255, 255, 0.05)'}; border: 3px solid ${backgroundSettings.type === 'solid' ? '#d4af37' : 'rgba(212, 175, 55, 0.3)'}; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 12px;">🎨</div>
                        <h4 style="color: ${backgroundSettings.type === 'solid' ? '#1a4d2e' : '#d4af37'}; font-size: 16px; margin-bottom: 8px; font-weight: 800;">WARNA SOLID</h4>
                        <p style="color: ${backgroundSettings.type === 'solid' ? '#1a4d2e' : 'white'}; font-size: 13px; line-height: 1.6; opacity: 0.9;">Satu warna polos</p>
                        ${backgroundSettings.type === 'solid' ? '<div style="margin-top: 12px; background: #1a4d2e; color: #d4af37; padding: 6px 12px; border-radius: 6px; font-weight: 700; font-size: 12px;">✓ AKTIF</div>' : ''}
                    </div>
                    
                    <!-- Gradient -->
                    <div onclick="selectBackgroundType('gradient')" style="background: ${backgroundSettings.type === 'gradient' ? 'linear-gradient(135deg, #d4af37 0%, #c9a636 100%)' : 'rgba(255, 255, 255, 0.05)'}; border: 3px solid ${backgroundSettings.type === 'gradient' ? '#d4af37' : 'rgba(212, 175, 55, 0.3)'}; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 12px;">🌈</div>
                        <h4 style="color: ${backgroundSettings.type === 'gradient' ? '#1a4d2e' : '#d4af37'}; font-size: 16px; margin-bottom: 8px; font-weight: 800;">GRADASI</h4>
                        <p style="color: ${backgroundSettings.type === 'gradient' ? '#1a4d2e' : 'white'}; font-size: 13px; line-height: 1.6; opacity: 0.9;">Perpaduan 2 warna</p>
                        ${backgroundSettings.type === 'gradient' ? '<div style="margin-top: 12px; background: #1a4d2e; color: #d4af37; padding: 6px 12px; border-radius: 6px; font-weight: 700; font-size: 12px;">✓ AKTIF</div>' : ''}
                    </div>
                    
                    <!-- Image -->
                    <div onclick="selectBackgroundType('image')" style="background: ${backgroundSettings.type === 'image' ? 'linear-gradient(135deg, #d4af37 0%, #c9a636 100%)' : 'rgba(255, 255, 255, 0.05)'}; border: 3px solid ${backgroundSettings.type === 'image' ? '#d4af37' : 'rgba(212, 175, 55, 0.3)'}; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 12px;">🖼️</div>
                        <h4 style="color: ${backgroundSettings.type === 'image' ? '#1a4d2e' : '#d4af37'}; font-size: 16px; margin-bottom: 8px; font-weight: 800;">GAMBAR</h4>
                        <p style="color: ${backgroundSettings.type === 'image' ? '#1a4d2e' : 'white'}; font-size: 13px; line-height: 1.6; opacity: 0.9;">Gambar custom</p>
                        ${backgroundSettings.type === 'image' ? '<div style="margin-top: 12px; background: #1a4d2e; color: #d4af37; padding: 6px 12px; border-radius: 6px; font-weight: 700; font-size: 12px;">   AKTIF</div>' : ''}
                    </div>
                </div>
                
                <!-- Settings untuk masing-masing type -->
                <div id="background-settings-container" style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px; border: 2px solid #d4af37;">
                    ${renderBackgroundSettings()}
                </div>
                
                <div style="margin-top: 20px; padding: 16px; background: rgba(212, 175, 55, 0.1); border-left: 4px solid #d4af37; border-radius: 6px;">
                    <div style="color: #d4af37; font-weight: 700; margin-bottom: 8px;">💡 Tips:</div>
                    <ul style="color: white; font-size: 14px; line-height: 1.8; margin-left: 20px;">
                        <li><strong>Warna Solid:</strong> Cocok untuk tampilan yang simpel dan elegan</li>
                        <li><strong>Gradasi:</strong> Memberikan kesan modern dengan perpaduan 2 warna</li>
                        <li><strong>Gambar:</strong> Gunakan foto masjid atau motif islami sebagai background</li>
                        <li>Pastikan kontras warna cukup agar teks tetap mudah dibaca</li>
                    </ul>
                </div>
            `;
        }

        function renderBackgroundSettings() {
            if (backgroundSettings.type === 'solid') {
                return `
                    <h4 style="color: #d4af37; margin-bottom: 16px; font-size: 18px;">⚙️ Pengaturan Warna Solid</h4>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Pilih Warna:</label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="color" id="solid-color-input" value="${backgroundSettings.solidColor}" style="width: 80px; height: 50px; border: 2px solid #d4af37; border-radius: 8px; cursor: pointer; background: transparent;">
                            <input type="text" id="solid-color-text" value="${backgroundSettings.solidColor}" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                        </div>
                    </div>
                    <button onclick="applyBackgroundSettings()" style="width: 100%; background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 700; margin-top: 16px;">✅ TERAPKAN PERUBAHAN</button>
                `;
            } else if (backgroundSettings.type === 'gradient') {
                return `
                    <h4 style="color: #d4af37; margin-bottom: 16px; font-size: 18px;">⚙️ Pengaturan Gradasi</h4>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div>
                            <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Warna 1 (Awal):</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="color" id="gradient-color1-input" value="${backgroundSettings.gradientColor1}" style="width: 80px; height: 50px; border: 2px solid #d4af37; border-radius: 8px; cursor: pointer; background: transparent;">
                                <input type="text" id="gradient-color1-text" value="${backgroundSettings.gradientColor1}" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Warna 2 (Akhir):</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="color" id="gradient-color2-input" value="${backgroundSettings.gradientColor2}" style="width: 80px; height: 50px; border: 2px solid #d4af37; border-radius: 8px; cursor: pointer; background: transparent;">
                                <input type="text" id="gradient-color2-text" value="${backgroundSettings.gradientColor2}" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Arah Gradasi: <span id="angle-display" style="color: #d4af37;">${backgroundSettings.gradientAngle}</span></label>
                            <input type="range" id="gradient-angle-input" min="0" max="360" step="45" value="${parseInt(backgroundSettings.gradientAngle)}" style="width: 100%; cursor: pointer;" oninput="updateAngleDisplay(this.value)">
                            <div style="display: flex; justify-content: space-between; color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-top: 4px;">
                                <span>0° (→)</span>
                                <span>90° (↓)</span>
                                <span>180° (←)</span>
                                <span>270° (↑)</span>
                                <span>360° (→)</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="applyBackgroundSettings()" style="width: 100%; background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 700; margin-top: 16px;">✅ TERAPKAN PERUBAHAN</button>
                `;
            } else if (backgroundSettings.type === 'image') {
                return `
                    <h4 style="color: #d4af37; margin-bottom: 16px; font-size: 18px;">⚙️ Pengaturan Gambar Background</h4>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div>
                            <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">URL Gambar:</label>
                            <input type="text" id="bg-image-url" value="${backgroundSettings.imageUrl}" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px; margin-bottom: 8px;">
                            <input type="file" id="bg-image-upload" accept="image/*" style="display: none;" onchange="handleBgImageUpload(event)">
                            <button onclick="document.getElementById('bg-image-upload').click()" style="width: 100%; background: rgba(212, 175, 55, 0.2); color: #d4af37; border: 2px solid #d4af37; border-radius: 6px; padding: 10px; cursor: pointer; font-size: 14px; font-weight: 600;">   Upload dari Komputer</button>
                        </div>
                        <div>
                            <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Transparansi Gambar: <span id="opacity-display" style="color: #d4af37;">${Math.round(backgroundSettings.imageOpacity * 100)}%</span></label>
                            <input type="range" id="bg-image-opacity" min="0" max="1" step="0.1" value="${backgroundSettings.imageOpacity}" style="width: 100%; cursor: pointer;" oninput="updateOpacityDisplay(this.value)">
                            <div style="display: flex; justify-content: space-between; color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-top: 4px;">
                                <span>0% (Transparan)</span>
                                <span>50%</span>
                                <span>100% (Solid)</span>
                            </div>
                        </div>
                        ${backgroundSettings.imageUrl ? `
                        <div>
                            <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Preview:</label>
                            <div style="width: 100%; height: 150px; border-radius: 8px; border: 2px solid #d4af37; overflow: hidden; background: #000;">
                                <img src="${backgroundSettings.imageUrl}" style="width: 100%; height: 100%; object-fit: cover; opacity: ${backgroundSettings.imageOpacity};" alt="Preview" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display: flex; align-items: center; justify-content: center; height: 100%; color: #f87171;\\'>Gagal memuat gambar</div>';">
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <button onclick="applyBackgroundSettings()" style="width: 100%; background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 700; margin-top: 16px;">✅ TERAPKAN PERUBAHAN</button>
                `;
            }
        }

        function attachBackgroundEventListeners() {
            // Sync color picker with text input for solid
            const solidColorInput = document.getElementById('solid-color-input');
            const solidColorText = document.getElementById('solid-color-text');
            if (solidColorInput && solidColorText) {
                solidColorInput.addEventListener('input', (e) => {
                    solidColorText.value = e.target.value;
                });
                solidColorText.addEventListener('input', (e) => {
                    solidColorInput.value = e.target.value;
                });
            }
            
            // Sync color pickers with text inputs for gradient
            const gradientColor1Input = document.getElementById('gradient-color1-input');
            const gradientColor1Text = document.getElementById('gradient-color1-text');
            if (gradientColor1Input && gradientColor1Text) {
                gradientColor1Input.addEventListener('input', (e) => {
                    gradientColor1Text.value = e.target.value;
                });
                gradientColor1Text.addEventListener('input', (e) => {
                    gradientColor1Input.value = e.target.value;
                });
            }
            
            const gradientColor2Input = document.getElementById('gradient-color2-input');
            const gradientColor2Text = document.getElementById('gradient-color2-text');
            if (gradientColor2Input && gradientColor2Text) {
                gradientColor2Input.addEventListener('input', (e) => {
                    gradientColor2Text.value = e.target.value;
                });
                gradientColor2Text.addEventListener('input', (e) => {
                    gradientColor2Input.value = e.target.value;
                });
            }
        }

        window.updateAngleDisplay = function(value) {
            document.getElementById('angle-display').textContent = value + '  ';
        };

        window.updateOpacityDisplay = function(value) {
            document.getElementById('opacity-display').textContent = Math.round(value * 100) + '%';
        };

        window.selectBackgroundType = function(type) {
            backgroundSettings.type = type;
            showTab('background');
            showNotification('✅ Tipe background dipilih: ' + (type === 'solid' ? 'Warna Solid' : type === 'gradient' ? 'Gradasi' : 'Gambar'));
        };

        window.applyBackgroundSettings = function() {
            if (backgroundSettings.type === 'solid') {
                const solidColorText = document.getElementById('solid-color-text');
                if (solidColorText) {
                    backgroundSettings.solidColor = solidColorText.value;
                }
            } else if (backgroundSettings.type === 'gradient') {
                const gradientColor1Text = document.getElementById('gradient-color1-text');
                const gradientColor2Text = document.getElementById('gradient-color2-text');
                const gradientAngleInput = document.getElementById('gradient-angle-input');
                
                if (gradientColor1Text && gradientColor2Text && gradientAngleInput) {
                    backgroundSettings.gradientColor1 = gradientColor1Text.value;
                    backgroundSettings.gradientColor2 = gradientColor2Text.value;
                    backgroundSettings.gradientAngle = gradientAngleInput.value + 'deg';
                }
            } else if (backgroundSettings.type === 'image') {
                const bgImageUrl = document.getElementById('bg-image-url');
                const bgImageOpacity = document.getElementById('bg-image-opacity');
                
                if (bgImageUrl && bgImageOpacity) {
                    backgroundSettings.imageUrl = bgImageUrl.value;
                    backgroundSettings.imageOpacity = parseFloat(bgImageOpacity.value);
                }
            }
            
            applyBackground();
            showNotification('✅ Background berhasil diterapkan!');
        };

        window.handleBgImageUpload = function(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('⚠️ Ukuran file maksimal 10MB!');
                    return;
                }
                
                if (!file.type.startsWith('image/')) {
                    showNotification('⚠️ File harus berupa gambar!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    backgroundSettings.imageUrl = e.target.result;
                    document.getElementById('bg-image-url').value = e.target.result;
                    showTab('background'); // Refresh to show preview
                    showNotification('✅ Gambar berhasil diupload!');
                };
                reader.onerror = function() {
                    showNotification('❌ Gagal membaca file!');
                };
                reader.readAsDataURL(file);
            }
        };

        function applyBackground() {
            const mainContainer = document.getElementById('main-container');
            const headerBanner = document.getElementById('header-banner');
            
            if (backgroundSettings.type === 'solid') {
                // Apply solid color to main container
                mainContainer.style.background = backgroundSettings.solidColor;
                mainContainer.style.backgroundImage = 'none';
                
                // Apply matching gradient to banner
                const color = backgroundSettings.solidColor;
                headerBanner.style.background = `linear-gradient(90deg, ${color} 0%, ${adjustBrightness(color, 20)} 50%, ${color} 100%)`;
            } else if (backgroundSettings.type === 'gradient') {
                // Apply gradient to main container
                mainContainer.style.background = `linear-gradient(${backgroundSettings.gradientAngle}, ${backgroundSettings.gradientColor1} 0%, ${backgroundSettings.gradientColor2} 100%)`;
                mainContainer.style.backgroundImage = '';
                
                // Apply matching gradient to banner
                headerBanner.style.background = `linear-gradient(90deg, ${backgroundSettings.gradientColor1} 0%, ${backgroundSettings.gradientColor2} 50%, ${backgroundSettings.gradientColor1} 100%)`;
            } else if (backgroundSettings.type === 'image') {
                if (backgroundSettings.imageUrl) {
                    mainContainer.style.background = '#000';
                    mainContainer.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, ${1 - backgroundSettings.imageOpacity}), rgba(0, 0, 0, ${1 - backgroundSettings.imageOpacity})), url('${backgroundSettings.imageUrl}')`;
                    mainContainer.style.backgroundSize = 'cover';
                    mainContainer.style.backgroundPosition = 'center';
                    mainContainer.style.backgroundRepeat = 'no-repeat';
                    
                    // Use dark gradient for banner when using image background
                    headerBanner.style.background = 'linear-gradient(90deg, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.5) 50%, rgba(0, 0, 0, 0.7) 100%)';
                } else {
                    mainContainer.style.background = 'linear-gradient(135deg, #1a4d2e 0%, #0d2818 100%)';
                    mainContainer.style.backgroundImage = '';
                    headerBanner.style.background = 'linear-gradient(90deg, #1a4d2e 0%, #2d6b42 50%, #1a4d2e 100%)';
                }
            }
        }
        
        // Helper function to adjust color brightness
        function adjustBrightness(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        function renderWaktuTab() {
            let html = '<h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">🕌 Edit Waktu Sholat</h3>';
            
            // Excel Upload Section
            html += `
                <div style="background: rgba(212, 175, 55, 0.1); padding: 16px; border-radius: 8px; border: 1px dashed #d4af37; margin-bottom: 24px;">
                    <h4 style="color: #d4af37; font-size: 16px; margin-bottom: 12px; font-weight: 700;">📂 Import Jadwal Excel (Otomatis)</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                        <button onclick="downloadTemplate()" style="background: #1a4d2e; color: #d4af37; border: 1px solid #d4af37; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            📥 Download Template
                        </button>
                        <input type="file" id="excel-upload" accept=".xlsx, .xls" style="color: white;">
                    </div>
                    <div id="excel-status" style="margin-top: 8px; font-size: 13px; color: rgba(255,255,255,0.7);">
                        ${getExcelStatusText()}
                    </div>
                </div>
            `;

            html += '<h4 style="color: #d4af37; font-size: 16px; margin-bottom: 12px; font-weight: 700;">✏️ Edit Manual (Hari Ini)</h4>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">';
            
            prayerTimes.forEach((prayer, index) => {
                html += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; border: 1px solid #d4af37;">
                        <label style="display: block; color: #d4af37; margin-bottom: 8px; font-weight: 700;">${prayer.name}:</label>
                        <input type="time" id="time-${index}" value="${prayer.time}" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<button id="save-waktu-btn" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer; margin-top: 16px;">💾 SIMPAN PERUBAHAN MANUAL</button>';
            
            return html;
        }

        function renderVisibilityTab() {
            let html = '<h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">👁️ Atur Tampilan Waktu Sholat</h3>';
            html += '<div style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 20px;">Pilih waktu sholat mana yang ingin ditampilkan di layar utama:</div>';
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            prayerTimes.forEach((prayer, index) => {
                html += `
                    <div onclick="togglePrayerVisibility(${index})" style="background: ${prayer.visible ? 'rgba(212, 175, 55, 0.2)' : 'rgba(255, 255, 255, 0.05)'}; padding: 16px; border-radius: 8px; border: 2px solid ${prayer.visible ? '#d4af37' : 'rgba(212, 175, 55, 0.3)'}; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="font-size: 32px;">${prayer.visible ? '✅' : '⬜'}</div>
                            <div>
                                <div style="color: ${prayer.visible ? '#d4af37' : 'white'}; font-weight: 700; font-size: 18px; margin-bottom: 4px;">${prayer.name}</div>
                                <div style="color: ${prayer.visible ? '#d4af37' : 'rgba(255, 255, 255, 0.6)'}; font-size: 14px;">${prayer.time}</div>
                            </div>
                        </div>
                        <div style="background: ${prayer.visible ? '#d4af37' : 'rgba(255, 255, 255, 0.2)'}; color: ${prayer.visible ? '#1a4d2e' : 'white'}; padding: 8px 16px; border-radius: 6px; font-weight: 700; font-size: 14px;">
                            ${prayer.visible ? 'TAMPILKAN' : 'SEMBUNYIKAN'}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div style="margin-top: 20px; padding: 16px; background: rgba(212, 175, 55, 0.1); border-left: 4px solid #d4af37; border-radius: 6px;">';
            html += '<div style="color: #d4af37; font-weight: 700; margin-bottom: 8px;">💡 Tips:</div>';
            html += '<ul style="color: white; font-size: 14px; line-height: 1.8; margin-left: 20px;">';
            html += '<li><strong>Imsak, Syuruq, Dhuha:</strong> Waktu-waktu ini bisa disembunyikan jika tidak diperlukan</li>';
            html += '<li><strong>Subuh, Dzuhur, Ashar, Maghrib, Isya:</strong> Waktu sholat wajib yang biasanya ditampilkan</li>';
            html += '<li>Klik pada kotak untuk mengubah status tampilan</li>';
            html += '</ul>';
            html += '</div>';
            
            return html;
        }

        function attachVisibilityEventListeners() {
            // Event listeners handled by onclick in HTML
        }

        window.togglePrayerVisibility = function(index) {
            prayerTimes[index].visible = !prayerTimes[index].visible;
            renderPrayerCards();
            showTab('visibility'); // Refresh tab to show updated state
            saveToLocalStorage();
            showNotification(prayerTimes[index].visible ? `✅ ${prayerTimes[index].name} akan ditampilkan` : `✅ ${prayerTimes[index].name} disembunyikan`);
        };

        function attachWaktuEventListeners() {
            document.getElementById('save-waktu-btn').addEventListener('click', () => {
                prayerTimes.forEach((prayer, index) => {
                    prayer.time = document.getElementById(`time-${index}`).value;
                });
                renderPrayerCards();
                saveToLocalStorage();
                showNotification('✅ Waktu sholat berhasil diupdate!');
            });

            const fileInput = document.getElementById('excel-upload');
            if(fileInput) {
                fileInput.addEventListener('change', handleExcelUpload);
            }
        }

        // --- EXCEL & AUTO UPDATE LOGIC ---


        function getExcelStatusText() {
            if (!prayerScheduleData || prayerScheduleData.length === 0) {
                return "ℹ️ Belum ada data jadwal. Silakan upload file Excel.";
            }
            return `✅ Tersimpan: ${prayerScheduleData.length} hari data jadwal.`;
        }

        function downloadTemplate() {
            const headers = ["Tanggal", "Subuh", "Dzuhur", "Ashar", "Maghrib", "Isya", "Imsak", "Syuruq", "Dhuha"];
            const exampleRow = ["2024-01-01", "04:30", "12:00", "15:15", "18:00", "19:15", "04:20", "05:45", "06:15"];
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, exampleRow]);
            XLSX.utils.book_append_sheet(wb, ws, "Template Jadwal");
            XLSX.writeFile(wb, "Template_Jadwal_Sholat.xlsx");
        }

        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {raw: false}); // raw:false ensures dates are strings if formatted

                    if (jsonData.length > 0) {
                        // Validate columns slightly
                        const firstRow = jsonData[0];
                        if (!firstRow.hasOwnProperty('Tanggal') || !firstRow.hasOwnProperty('Subuh')) {
                            alert("Format Excel tidak sesuai! Pastikan menggunakan template.");
                            return;
                        }

                        prayerScheduleData = jsonData;
                        saveToLocalStorage();
                        // localStorage.setItem('prayerScheduleData', JSON.stringify(jsonData)); // Handled by saveToLocalStorage
                        
                        document.getElementById('excel-status').textContent = getExcelStatusText();
                        showNotification(`✅ Berhasil import ${jsonData.length} hari jadwal!`);
                        
                        // Update today's schedule immediately
                        checkDailyUpdate();
                        
                        // Close modal to show changes
                        setTimeout(() => {
                             // Optional: close modal or just refresh cards
                             renderPrayerCards();
                        }, 1000);
                    }
                } catch (err) {
                    console.error(err);
                    alert("Gagal membaca file Excel. Pastikan file tidak rusak.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function checkDailyUpdate() {
            if (!prayerScheduleData || prayerScheduleData.length === 0) return;

            const now = new Date();
            // Format YYYY-MM-DD to match Excel standard text
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`; // 2024-12-30
            
            // Also try DD/MM/YYYY or M/D/YY just in case, but let's stick to standard first.
            // Better: Normalize dates.
            
            const todayEntry = prayerScheduleData.find(row => {
                // Handle various date formats from Excel
                // Case 1: "2024-12-30" or "12/30/24" string
                if (typeof row.Tanggal === 'string') {
                    return row.Tanggal.includes(todayStr) || row.Tanggal === `${day}/${month}/${year}`;
                }
                // Case 2: Excel Serial Date (if raw:true was used, but we used raw:false)
                return false;
            });

            if (todayEntry) {
                console.log("Found schedule for today:", todayEntry);
                let updated = false;
                
                // Map Excel columns to prayerTimes array
                // prayerTimes = [{name: "Subuh", time: "04:45"}, ...]
                
                const mapNames = {
                    "Subuh": "Subuh",
                    "Dzuhur": "Dzuhur",
                    "Ashar": "Ashar", 
                    "Maghrib": "Maghrib",
                    "Isya": "Isya",
                    "Imsak": "Imsak",
                    "Syuruq": "Syuruq",
                    "Dhuha": "Dhuha"
                };

                prayerTimes.forEach(p => {
                    const excelKey = Object.keys(mapNames).find(k => mapNames[k] === p.name);
                    if (excelKey && todayEntry[excelKey]) {
                        // Simple validation of time format HH:MM
                        let t = todayEntry[excelKey].trim();
                        // If excel has seconds like 04:30:00, take first 5 chars
                        if (t.length > 5) t = t.substring(0, 5);
                        
                        if (p.time !== t) {
                            p.time = t;
                            updated = true;
                        }
                    }
                });

                if (updated) {
                    renderPrayerCards();
                    // Optional: show a small toast that schedule was updated
                    console.log("Jadwal sholat diperbarui otomatis dari Excel.");
                }
            }
        }


        function renderPengumumanTab() {
            return `
                <h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">📢 Edit Pengumuman Teks</h3>
                <div>
                    <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Isi Pengumuman:</label>
                    <textarea id="edit-announcement" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px; min-height: 150px; resize: vertical;">${currentAnnouncement}</textarea>
                    <button id="save-announcement-btn" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer; margin-top: 12px;">💾 SIMPAN PERUBAHAN</button>
                </div>
            `;
        }

        function renderModePengumumanTab() {
            return `
                <h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">🎨 Pilih Mode Tampilan Pengumuman</h3>
                <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 20px;">
                    Pilih bagaimana Anda ingin menampilkan pengumuman di layar utama:
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Mode Text -->
                    <div onclick="selectAnnouncementMode('text')" style="background: ${announcementMode === 'text' ? 'linear-gradient(135deg, #d4af37 0%, #c9a636 100%)' : 'rgba(255, 255, 255, 0.05)'}; border: 3px solid ${announcementMode === 'text' ? '#d4af37' : 'rgba(212, 175, 55, 0.3)'}; border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 12px;">📝</div>
                        <h4 style="color: ${announcementMode === 'text' ? '#1a4d2e' : '#d4af37'}; font-size: 18px; margin-bottom: 8px; font-weight: 800;">MODE TEKS</h4>
                        <p style="color: ${announcementMode === 'text' ? '#1a4d2e' : 'white'}; font-size: 14px; line-height: 1.6; opacity: 0.9;">Tampilkan pengumuman dalam bentuk teks yang mudah dibaca</p>
                        ${announcementMode === 'text' ? '<div style="margin-top: 12px; background: #1a4d2e; color: #d4af37; padding: 6px 12px; border-radius: 6px; font-weight: 700; font-size: 12px;">✓ AKTIF SEKARANG</div>' : ''}
                    </div>
                    
                    <!-- Mode Slideshow -->
                    <div onclick="selectAnnouncementMode('slideshow')" style="background: ${announcementMode === 'slideshow' ? 'linear-gradient(135deg, #d4af37 0%, #c9a636 100%)' : 'rgba(255, 255, 255, 0.05)'}; border: 3px solid ${announcementMode === 'slideshow' ? '#d4af37' : 'rgba(212, 175, 55, 0.3)'}; border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 12px;">🖼️</div>
                        <h4 style="color: ${announcementMode === 'slideshow' ? '#1a4d2e' : '#d4af37'}; font-size: 18px; margin-bottom: 8px; font-weight: 800;">MODE SLIDESHOW</h4>
                        <p style="color: ${announcementMode === 'slideshow' ? '#1a4d2e' : 'white'}; font-size: 14px; line-height: 1.6; opacity: 0.9;">Tampilkan pengumuman dalam bentuk gambar slideshow otomatis</p>
                        ${announcementMode === 'slideshow' ? '<div style="margin-top: 12px; background: #1a4d2e; color: #d4af37; padding: 6px 12px; border-radius: 6px; font-weight: 700; font-size: 12px;">✓ AKTIF SEKARANG</div>' : ''}
                    </div>
                </div>
                
                <div style="margin-top: 24px; padding: 16px; background: rgba(212, 175, 55, 0.1); border-left: 4px solid #d4af37; border-radius: 6px;">
                    <div style="color: #d4af37; font-weight: 700; margin-bottom: 8px;">💡 Tips:</div>
                    <ul style="color: white; font-size: 14px; line-height: 1.8; margin-left: 20px;">
                        <li><strong>Mode Teks:</strong> Cocok untuk pengumuman singkat dan penting yang perlu dibaca dengan cepat</li>
                        <li><strong>Mode Slideshow:</strong> Cocok untuk pengumuman bergambar, event, atau informasi visual yang menarik</li>
                    </ul>
                </div>
            `;
        }

        function attachModePengumumanEventListeners() {
            // Event listeners handled by onclick in HTML
        }

        window.selectAnnouncementMode = function(mode) {
            announcementMode = mode;
            updateAnnouncementDisplay();
            showTab('mode-pengumuman'); // Refresh tab to show updated selection
            saveToLocalStorage();
            showNotification(mode === 'text' ? '✅ Mode Teks aktif!' : '✅ Mode Slideshow aktif!');
        };

        function renderSlideshowTab() {
            let html = '<h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">         Kelola Slideshow Pengumuman (Maksimal 5 Gambar)</h3>';
            html += '<div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">';
            
            slideshowData.forEach((slide, index) => {
                html += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 2px solid ${slide.imageUrl ? '#d4af37' : 'rgba(212, 175, 55, 0.3)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="color: #d4af37; margin: 0;">🖼️ Slide #${index + 1}</h4>
                            ${slide.imageUrl ? `<button onclick="clearSlide(${index})" style="background: #f87171; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-weight: 600; font-size: 12px;">🗑️ Hapus</button>` : ''}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 16px;">
                            <div style="text-align: center;">
                                <div style="width: 180px; height: 135px; margin: 0 auto 8px; border-radius: 8px; background: rgba(212, 175, 55, 0.2); display: flex; align-items: center; justify-content: center; border: 2px solid #d4af37; overflow: hidden;">
                                    ${slide.imageUrl ? `<img id="slide-preview-${index}" src="${slide.imageUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="Preview" onerror="this.style.display='none'; this.parentElement.innerHTML='<svg style=\\'width: 50px; height: 50px; color: #d4af37;\\' fill=\\'currentColor\\' viewBox=\\'0 0 20 20\\'><path d=\\'M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z\\'/></svg><div style=\\'color: #f87171; font-size: 10px; margin-top: 4px;\\'>Gagal memuat</div>';">` : `<svg style="width: 50px; height: 50px; color: #d4af37;" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/></svg>`}
                                </div>
                                <button onclick="previewSlide(${index})" style="background: rgba(212, 175, 55, 0.2); color: #d4af37; border: 2px solid #d4af37; border-radius: 6px; padding: 4px 12px; cursor: pointer; font-size: 11px; font-weight: 600;">   ️ Preview</button>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <label style="display: block; color: white; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Keterangan:</label>
                                    <input type="text" id="slide-caption-${index}" value="${slide.caption}" placeholder="Keterangan slide" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; color: white; margin-bottom: 4px; font-size: 12px; font-weight: 600;">URL Gambar:</label>
                                    <input type="text" id="slide-url-${index}" value="${slide.imageUrl}" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; margin-bottom: 8px;">
                                    <input type="file" id="slide-upload-${index}" accept="image/*" style="display: none;" onchange="handleSlideUpload(${index}, event)">
                                    <button onclick="document.getElementById('slide-upload-${index}').click()" style="width: 100%; background: rgba(212, 175, 55, 0.2); color: #d4af37; border: 2px solid #d4af37; border-radius: 6px; padding: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">📁 Upload dari Komputer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #d4af37;">';
            html += '<div style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-bottom: 12px;">💡 <strong>Tip:</strong> Anda bisa upload gambar langsung dari komputer (max 5MB) atau menggunakan URL gambar dari internet. Gambar akan berganti otomatis setiap 5 detik.</div>';
            html += '<button id="save-slideshow-btn" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer; width: 100%;">💾 SIMPAN SEMUA PERUBAHAN</button>';
            html += '</div>';
            
            return html;
        }

        function attachPengumumanEventListeners() {
            document.getElementById('save-announcement-btn').addEventListener('click', () => {
                currentAnnouncement = document.getElementById('edit-announcement').value;
                document.getElementById('announcement-text').textContent = currentAnnouncement;
                saveToLocalStorage();
                showNotification('✅ Pengumuman berhasil diupdate!');
            });
        }

        function attachSlideshowEventListeners() {
            document.getElementById('save-slideshow-btn').addEventListener('click', () => {
                slideshowData.forEach((slide, index) => {
                    slide.caption = document.getElementById(`slide-caption-${index}`).value;
                    slide.imageUrl = document.getElementById(`slide-url-${index}`).value;
                });
                currentSlideIndex = 0;
                renderSlideshow();
                startSlideshow();
                saveToLocalStorage();
                showNotification('✅ Slideshow berhasil disimpan!');
            });
        }

        window.previewSlide = function(index) {
            const imageUrl = document.getElementById(`slide-url-${index}`).value;
            const previewImg = document.getElementById(`slide-preview-${index}`);
            
            if (imageUrl) {
                const parentDiv = previewImg ? previewImg.parentElement : document.querySelector(`#slide-preview-${index}`).parentElement;
                parentDiv.innerHTML = `<img id="slide-preview-${index}" src="${imageUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="Preview" onerror="this.style.display='none'; this.parentElement.innerHTML='<svg style=\\'width: 50px; height: 50px; color: #d4af37;\\' fill=\\'currentColor\\' viewBox=\\'0 0 20 20\\'><path d=\\'M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z\\'/></svg><div style=\\'color: #f87171; font-size: 10px; margin-top: 4px;\\'>Gagal memuat</div>';">`;
                showNotification('👁️ Preview diupdate!');
            } else {
                showNotification('⚠️ Masukkan URL gambar terlebih dahulu!');
            }
        };

        window.clearSlide = function(index) {
            slideshowData[index] = { imageUrl: "", caption: `Slide ${index + 1}` };
            renderSlideshow();
            startSlideshow();
            showTab('slideshow');
            showNotification('✅ Slide berhasil dihapus!');
        };

        window.handleSlideUpload = function(index, event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('⚠️ Ukuran file maksimal 5MB!');
                    return;
                }
                
                if (!file.type.startsWith('image/')) {
                    showNotification('⚠️ File harus berupa gambar!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;
                    document.getElementById(`slide-url-${index}`).value = dataUrl;
                    
                    const previewImg = document.getElementById(`slide-preview-${index}`);
                    if (previewImg) {
                        const parentDiv = previewImg.parentElement;
                        parentDiv.innerHTML = `<img id="slide-preview-${index}" src="${dataUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="Preview">`;
                    }
                    
                    showNotification('✅ Gambar berhasil diupload!');
                };
                reader.onerror = function() {
                    showNotification('❌ Gagal membaca file!');
                };
                reader.readAsDataURL(file);
            }
        };

        function renderInfoTab() {
            return `
                <h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">ℹ️ Edit Info Masjid</h3>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Kapasitas:</label>
                        <input type="text" id="edit-capacity" value="${infoMasjidData.capacity}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Fasilitas:</label>
                        <input type="text" id="edit-facilities" value="${infoMasjidData.facilities}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Iqomah:</label>
                        <input type="text" id="edit-iqomah" value="${infoMasjidData.iqomah}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Kontak:</label>
                        <input type="text" id="edit-contact" value="${infoMasjidData.contact}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Info Ramadhan/Raya:</label>
                        <input type="text" id="edit-ramadhan" value="${infoMasjidData.ramadhan}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Info Qurban:</label>
                        <input type="text" id="edit-qurban" value="${infoMasjidData.qurban}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">No. Rekening:</label>
                        <input type="text" id="edit-rekening" value="${infoMasjidData.rekening}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <button id="save-info-btn" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer; margin-top: 8px;">💾 SIMPAN PERUBAHAN</button>
                </div>
                
                <h3 style="color: #d4af37; font-size: 20px; margin: 24px 0 12px;">🔧 Pengaturan Tampilan Info</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: start;">
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.4);">
                        <div style="color: #d4af37; font-weight: 700; margin-bottom: 8px;">Pilih Informasi yang Ditampilkan</div>
                        <label style="display: flex; align-items: center; gap: 8px; color: white; margin-bottom: 6px;"><input type="checkbox" id="info-visible-capacity" ${infoVisibilityConfig.capacity ? 'checked' : ''}> Kapasitas</label>
                        <label style="display: flex; align-items: center; gap: 8px; color: white; margin-bottom: 6px;"><input type="checkbox" id="info-visible-facilities" ${infoVisibilityConfig.facilities ? 'checked' : ''}> Fasilitas</label>
                        <label style="display: flex; align-items: center; gap: 8px; color: white; margin-bottom: 6px;"><input type="checkbox" id="info-visible-iqomah" ${infoVisibilityConfig.iqomah ? 'checked' : ''}> Iqomah</label>
                        <label style="display: flex; align-items: center; gap: 8px; color: white; margin-bottom: 6px;"><input type="checkbox" id="info-visible-contact" ${infoVisibilityConfig.contact ? 'checked' : ''}> Kontak</label>
                        <label style="display: flex; align-items: center; gap: 8px; color: white; margin-bottom: 6px;"><input type="checkbox" id="info-visible-ramadhan" ${infoVisibilityConfig.ramadhan ? 'checked' : ''}> Info Ramadhan/Raya</label>
                        <label style="display: flex; align-items: center; gap: 8px; color: white; margin-bottom: 6px;"><input type="checkbox" id="info-visible-qurban" ${infoVisibilityConfig.qurban ? 'checked' : ''}> Info Qurban</label>
                        <label style="display: flex; align-items: center; gap: 8px; color: white;"><input type="checkbox" id="info-visible-rekening" ${infoVisibilityConfig.rekening ? 'checked' : ''}> No. Rekening</label>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.4);">
                        <div style="color: #d4af37; font-weight: 700; margin-bottom: 8px;">Pergantian Otomatis</div>
                        <label style="display: flex; align-items: center; gap: 8px; color: white; margin-bottom: 8px;"><input type="checkbox" id="info-auto-rotate" ${infoAutoRotate ? 'checked' : ''}> Aktifkan ganti otomatis</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="info-rotate-interval" min="3" max="20" value="${infoRotateIntervalSec}" oninput="document.getElementById('info-rotate-interval-display').textContent=this.value+' dtk'" style="flex: 1;">
                            <div id="info-rotate-interval-display" style="width: 64px; text-align: right; color: white;">${infoRotateIntervalSec} dtk</div>
                        </div>
                    </div>
                </div>
                <button id="save-info-visibility-btn" style="margin-top: 12px; background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer;">✅ SIMPAN PENGATURAN TAMPILAN</button>
            `;
        }

        function attachInfoEventListeners() {
            document.getElementById('save-info-btn').addEventListener('click', () => {
                infoMasjidData = {
                    capacity: document.getElementById('edit-capacity').value,
                    facilities: document.getElementById('edit-facilities').value,
                    iqomah: document.getElementById('edit-iqomah').value,
                    contact: document.getElementById('edit-contact').value,
                    ramadhan: document.getElementById('edit-ramadhan').value,
                    qurban: document.getElementById('edit-qurban').value,
                    rekening: document.getElementById('edit-rekening').value
                };
                updateInfoDisplay();
                saveToLocalStorage();
                showNotification('✅ Info masjid berhasil diupdate!');
            });
            const saveVisibilityBtn = document.getElementById('save-info-visibility-btn');
            if (saveVisibilityBtn) {
                saveVisibilityBtn.addEventListener('click', () => {
                    infoVisibilityConfig = {
                        capacity: document.getElementById('info-visible-capacity').checked,
                        facilities: document.getElementById('info-visible-facilities').checked,
                        iqomah: document.getElementById('info-visible-iqomah').checked,
                        contact: document.getElementById('info-visible-contact').checked,
                        ramadhan: document.getElementById('info-visible-ramadhan').checked,
                        qurban: document.getElementById('info-visible-qurban').checked,
                        rekening: document.getElementById('info-visible-rekening').checked
                    };
                    infoAutoRotate = document.getElementById('info-auto-rotate').checked;
                    infoRotateIntervalSec = parseInt(document.getElementById('info-rotate-interval').value);
                    infoRotateIndex = 0;
                    updateInfoDisplay();
                    saveToLocalStorage();
                    if (infoAutoRotate) {
                        startInfoRotation();
                    } else {
                        stopInfoRotation();
                    }
                    showNotification('✅ Pengaturan tampilan info diterapkan!');
                });
            }
        }

        function renderDonaturTab() {
            let html = '<h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">💰 Kelola Donatur</h3>';
            
            // List existing donators
            html += '<div style="margin-bottom: 20px;">';
            donatorsData.forEach((donator, index) => {
                html += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #d4af37; gap: 12px;">
                        <div style="flex: 1; display: flex; gap: 8px;">
                            <input type="text" id="edit-donator-name-${index}" value="${donator.name}" placeholder="Nama Donatur" style="flex: 1; min-width: 180px; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white;">
                            <input type="text" id="edit-donator-amount-${index}" value="${donator.amount}" placeholder="Nominal (tanpa Rp)" style="flex: 1; min-width: 120px; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white;">
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="updateDonator(${index})" style="background: #22c55e; color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-weight: 600;">💾 Simpan</button>
                            <button onclick="deleteDonator(${index})" style="background: #f87171; color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-weight: 600;">🗑️ Hapus</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Add new form
            html += `
                <div style="background: rgba(212, 175, 55, 0.1); padding: 16px; border-radius: 8px; border: 2px solid #d4af37;">
                    <h4 style="color: #d4af37; margin-bottom: 12px;">➕ Tambah Donatur Baru</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <input type="text" id="new-donator-name" placeholder="Nama Donatur" style="flex: 1; min-width: 200px; padding: 10px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white;">
                        <input type="text" id="new-donator-amount" placeholder="Nominal (tanpa Rp)" style="flex: 1; min-width: 150px; padding: 10px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white;">
                        <button id="add-donator-btn" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 6px; padding: 10px 20px; font-weight: 700; cursor: pointer;">➕ TAMBAH</button>
                    </div>
                </div>
            `;
            
            return html;
        }

        function attachDonaturEventListeners() {
            document.getElementById('add-donator-btn').addEventListener('click', () => {
                const name = document.getElementById('new-donator-name').value;
                const amount = document.getElementById('new-donator-amount').value;
                
                if (name && amount) {
                    donatorsData.push({ name, amount });
                    updateDonaturDisplay();
                    showTab('donatur');
                    showNotification('✅ Donatur berhasil ditambahkan!');
                }
            });
        }

        function renderKeuanganTab() {
            const balance = parseFloat(financeData.income.replace(/\./g, '')) - parseFloat(financeData.expense.replace(/\./g, ''));
            return `
                <h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">💵 Kelola Keuangan</h3>
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Pemasukan Hari Ini (tanpa Rp):</label>
                        <input type="text" id="edit-today-income" value="${financeData.todayIncome}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Pemasukan Mingguan (tanpa Rp):</label>
                        <input type="text" id="edit-weekly-income" value="${financeData.weeklyIncome}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Pemasukan Jumat Lalu (tanpa Rp):</label>
                        <input type="text" id="edit-friday-income" value="${financeData.fridayIncome}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Penerimaan (tanpa Rp):</label>
                        <input type="text" id="edit-income" value="${financeData.income}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Pengeluaran (tanpa Rp):</label>
                        <input type="text" id="edit-expense" value="${financeData.expense}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">Pengeluaran Terakhir (tanpa Rp):</label>
                        <input type="text" id="edit-last-expense" value="${financeData.lastExpense}" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;">
                    </div>
                    <div style="background: rgba(212, 175, 55, 0.2); padding: 16px; border-radius: 8px; border: 2px solid #d4af37;">
                        <span style="color: white; font-weight: 600;">Saldo Saat Ini: </span>
                        <span style="color: #d4af37; font-weight: 800; font-size: 20px;">Rp ${balance.toLocaleString('id-ID')}</span>
                    </div>
                    <button id="save-finance-btn" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer; margin-top: 8px;">💾 SIMPAN PERUBAHAN</button>
                </div>
            `;
        }

        function attachKeuanganEventListeners() {
            document.getElementById('save-finance-btn').addEventListener('click', () => {
                financeData = {
                    todayIncome: document.getElementById('edit-today-income').value,
                    weeklyIncome: document.getElementById('edit-weekly-income').value,
                    fridayIncome: document.getElementById('edit-friday-income').value,
                    income: document.getElementById('edit-income').value,
                    expense: document.getElementById('edit-expense').value,
                    lastExpense: document.getElementById('edit-last-expense').value
                };
                updateFinanceDisplay();
                showNotification('✅ Keuangan berhasil diupdate!');
            });
        }

        function renderPetugasTab() {
            let html = '<h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">👥 Kelola Petugas Sholat</h3>';
            
            officersData.forEach((officer, index) => {
                html += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #d4af37;">
                        <div style="color: #d4af37; font-weight: 700; margin-bottom: 8px;">${officer.prayer}</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; align-items: end;">
                            <div>
                                <label style="display: block; color: white; margin-bottom: 4px; font-size: 12px;">Imam:</label>
                                <input type="text" id="officer-imam-${index}" value="${officer.imam}" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white;">
                            </div>
                            <div>
                                <label style="display: block; color: white; margin-bottom: 4px; font-size: 12px;">Muadzin:</label>
                                <input type="text" id="officer-muadzin-${index}" value="${officer.muadzin}" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white;">
                            </div>
                            <button onclick="deleteOfficer(${index})" style="background: #f87171; color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-weight: 600;">🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            html += '<button id="save-officers-btn" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer; margin-top: 8px;">   SIMPAN PERUBAHAN</button>';
            
            return html;
        }

        function attachPetugasEventListeners() {
            document.getElementById('save-officers-btn').addEventListener('click', () => {
                officersData.forEach((officer, index) => {
                    officer.imam = document.getElementById(`officer-imam-${index}`).value;
                    officer.muadzin = document.getElementById(`officer-muadzin-${index}`).value;
                });
                updateOfficersDisplay();
                saveToLocalStorage();
                showNotification('✅ Petugas sholat berhasil diupdate!');
            });
        }

        function renderTakmirTab() {
            let html = '<h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">📸 Kelola Foto Takmir / Poster</h3>';
            html += '<div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">';
            
            // Left Column Mode Settings
            html += `
                <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #d4af37;">
                    <h4 style="color: #d4af37; margin: 0 0 12px 0;">📱 Mode Tampilan Kolom Kiri</h4>
                    <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; color: white; cursor: pointer;">
                            <input type="radio" name="left-col-mode" value="takmir" ${leftColumnMode === 'takmir' ? 'checked' : ''}>
                            <span>Daftar Takmir (2 Kotak)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; color: white; cursor: pointer;">
                            <input type="radio" name="left-col-mode" value="image" ${leftColumnMode === 'image' ? 'checked' : ''}>
                            <span>Gambar Penuh (1 Gambar)</span>
                        </label>
                    </div>
                    
                    <div id="left-col-image-upload" style="display: ${leftColumnMode === 'image' ? 'block' : 'none'};">
                        <div style="margin-bottom: 12px;">
                             <div class="preview-box" style="width: 100%; height: 200px; border-radius: 8px; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; border: 2px dashed #d4af37; overflow: hidden; margin-bottom: 8px;">
                                ${leftColumnImageUrl ? `<img src="${leftColumnImageUrl}" style="width: 100%; height: 100%; object-fit: contain;">` : '<span style="color: rgba(255,255,255,0.5);">Preview Gambar</span>'}
                            </div>
                            <input type="text" id="left-col-image-url" value="${leftColumnImageUrl}" placeholder="URL Gambar..." style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; margin-bottom: 8px;">
                            <input type="file" id="left-col-file" accept="image/*" style="display: none;" onchange="handleLeftColImageUpload(event)">
                            <button onclick="document.getElementById('left-col-file').click()" style="width: 100%; background: rgba(212, 175, 55, 0.2); color: #d4af37; border: 2px solid #d4af37; border-radius: 6px; padding: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">📁 Upload Gambar Poster</button>
                        </div>
                    </div>
                </div>
            `;
            
            takmirData.forEach((takmir, index) => {
                html += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 2px solid ${takmir.name.trim() ? '#d4af37' : 'rgba(212, 175, 55, 0.3)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="color: #d4af37; margin: 0;">${index < 2 ? `Logo ${index + 1}` : `Takmir ${index - 1}`}</h4>
                            ${takmir.name.trim() ? `<button onclick="clearTakmir(${index})" style="background: #f87171; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-weight: 600; font-size: 12px;">🗑️ Hapus</button>` : ''}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 16px; margin-bottom: 12px;">
                            <div style="text-align: center;">
                                <div style="width: 100px; height: 133px; margin: 0 auto 8px; border-radius: 8px; background: linear-gradient(135deg, #d4af37 0%, #c9a636 100%); display: flex; align-items: center; justify-content: center; border: 3px solid #d4af37; overflow: hidden;">
                                    ${takmir.photoUrl ? `<img id="preview-${index}" src="${takmir.photoUrl}" style="width: 100%; height: 100%; object-fit: cover;" alt="Preview" onerror="this.style.display='none'; this.parentElement.innerHTML='<svg style=\\'width: 50px; height: 50px; color: #1a4d2e;\\' fill=\\'currentColor\\' viewBox=\\'0 0 20 20\\'><path d=\\'M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z\\'/></svg>';">` : `<svg style="width: 50px; height: 50px; color: #1a4d2e;" fill="currentColor" viewBox="0 0 20 20"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/></svg>`}
                                </div>
                                <button onclick="previewTakmir(${index})" style="background: rgba(212, 175, 55, 0.2); color: #d4af37; border: 2px solid #d4af37; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 11px; font-weight: 600;">👁️ Preview</button>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${index >= 2 ? `
                                <div>
                                    <label style="display: block; color: white; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Nama:</label>
                                    <input type="text" id="takmir-name-${index}" value="${takmir.name}" placeholder="Nama Takmir" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; color: white; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Jabatan:</label>
                                    <input type="text" id="takmir-position-${index}" value="${takmir.position}" placeholder="Jabatan" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                                </div>
                                ` : ''}
                                <div>
                                    <label style="display: block; color: white; margin-bottom: 4px; font-size: 12px; font-weight: 600;">URL Foto:</label>
                                    <input type="text" id="takmir-photo-${index}" value="${takmir.photoUrl}" placeholder="https://example.com/photo.jpg" style="width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #d4af37; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; margin-bottom: 8px;">
                                    <input type="file" id="takmir-upload-${index}" accept="image/*" style="display: none;" onchange="handleImageUpload(${index}, event)">
                                    <button onclick="document.getElementById('takmir-upload-${index}').click()" style="width: 100%; background: rgba(212, 175, 55, 0.2); color: #d4af37; border: 2px solid #d4af37; border-radius: 6px; padding: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">📁 Upload dari Komputer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #d4af37;">';
            html += '<div style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-bottom: 12px;">💡 <strong>Tip:</strong> Anda bisa upload foto langsung dari komputer (max 5MB) atau menggunakan URL foto dari internet</div>';
            html += '<button id="save-takmir-btn" style="background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 12px 24px; font-weight: 700; cursor: pointer; width: 100%;">💾 SIMPAN SEMUA PERUBAHAN</button>';
            html += '</div>';
            
            return html;
        }

        function attachTakmirEventListeners() {
            // Handle radio change to toggle visibility
            document.querySelectorAll('input[name="left-col-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                     document.getElementById('left-col-image-upload').style.display = e.target.value === 'image' ? 'block' : 'none';
                });
            });

            document.getElementById('save-takmir-btn').addEventListener('click', () => {
                // Save mode
                const modeRadios = document.querySelectorAll('input[name="left-col-mode"]');
                modeRadios.forEach(r => { if(r.checked) leftColumnMode = r.value; });
                
                // Save image URL
                const imgUrlInput = document.getElementById('left-col-image-url');
                if(imgUrlInput) leftColumnImageUrl = imgUrlInput.value;

                takmirData.forEach((takmir, index) => {
                    takmir.photoUrl = document.getElementById(`takmir-photo-${index}`).value;
                    if (index >= 2) {
                        const nameInput = document.getElementById(`takmir-name-${index}`);
                        const positionInput = document.getElementById(`takmir-position-${index}`);
                        if (nameInput) takmir.name = nameInput.value;
                        if (positionInput) takmir.position = positionInput.value;
                    }
                });
                updateTakmirDisplay();
                saveToLocalStorage();
                showNotification('✅ Data berhasil disimpan!');
            });
        }

        function renderBeepTab() {
            return `
                <h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">🔔 Upload Suara Beep Iqomah</h3>
                
                <div style="background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 12px; border: 2px solid #d4af37; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 64px; margin-bottom: 12px;">🔔</div>
                        <div style="color: white; font-size: 16px; margin-bottom: 8px;">
                            ${beepAudioUrl ? '<span style="color: #4ade80; font-weight: 700;">✅ Suara Beep Sudah Diupload</span>' : '<span style="color: rgba(255, 255, 255, 0.6);">Belum ada suara beep</span>'}
                        </div>
                    </div>
                    
                    ${beepAudioUrl ? `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <div style="color: #d4af37; font-weight: 700; margin-bottom: 12px;">Preview Suara Beep:</div>
                            <audio id="beep-preview" controls style="width: 100%; margin-bottom: 12px;">
                                <source src="${beepAudioUrl}" type="audio/mpeg">
                            </audio>
                            <button onclick="removeBeepAudio()" style="width: 100%; background: #f87171; color: white; border: none; border-radius: 6px; padding: 10px; cursor: pointer; font-weight: 700;">🗑️ HAPUS SUARA BEEP</button>
                        </div>
                    ` : ''}
                    
                    <input type="file" id="beep-audio-upload" accept="audio/*" style="display: none;" onchange="handleBeepAudioUpload(event)">
                    <button onclick="document.getElementById('beep-audio-upload').click()" style="width: 100%; background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 14px; cursor: pointer; font-weight: 700; font-size: 16px;">
                        📁 ${beepAudioUrl ? 'GANTI' : 'UPLOAD'} SUARA BEEP
                    </button>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid rgba(212, 175, 55, 0.4);">
                    <div style="color: #d4af37; font-weight: 700; margin-bottom: 8px;">Volume Beep Iqomah</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="range" id="beep-volume-slider" min="0" max="100" value="${Math.round(beepVolume * 100)}" oninput="updateBeepVolumeDisplay(this.value)" style="flex: 1;">
                        <div id="beep-volume-display" style="width: 60px; text-align: right; color: white;">${Math.round(beepVolume * 100)}%</div>
                    </div>
                    <button onclick="applyBeepVolume()" style="margin-top: 10px; background: #d4af37; color: #1a4d2e; border: none; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer;"> Terapkan Volume</button>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 8px; border-left: 4px solid #d4af37;">
                    <div style="color: #d4af37; font-weight: 700; margin-bottom: 12px;">💡 Panduan Upload Suara Beep:</div>
                    <ul style="color: white; font-size: 14px; line-height: 1.8; margin-left: 20px;">
                        <li>Format audio yang didukung: MP3, WAV, OGG, M4A</li>
                        <li>Ukuran file maksimal: <strong>5MB</strong></li>
                        <li>Durasi yang disarankan: <strong>3-10 detik</strong> (suara beep pendek)</li>
                        <li>Suara beep akan otomatis diputar saat pesan "MENUJU IQOMAH" muncul</li>
                        <li>Cocok untuk suara beep, bell, atau notifikasi pendek</li>
                    </ul>
                </div>
            `;
        }

        function attachBeepEventListeners() {
            // Event listeners handled by onclick in HTML
        }

        window.handleBeepAudioUpload = function(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (5MB limit for beep sound)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('⚠️ Ukuran file maksimal 5MB!');
                    return;
                }
                
                // Check if file is audio
                if (!file.type.startsWith('audio/')) {
                    showNotification('⚠️ File harus berupa audio (MP3, WAV, OGG, M4A)!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    beepAudioUrl = e.target.result;
                    showTab('beep'); // Refresh tab to show preview
                    saveToLocalStorage();
                    showNotification('   Suara beep berhasil diupload!');
                };
                reader.onerror = function() {
                    showNotification('    Gagal membaca file audio!');
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeBeepAudio = function() {
            beepAudioUrl = "";
            if (beepAudio) {
                beepAudio.pause();
                beepAudio.currentTime = 0;
                beepAudio = null;
            }
            showTab('beep');
            saveToLocalStorage();
            showNotification('✅ Suara beep berhasil dihapus!');
        };

        function renderAudioTab() {
            return `
                <h3 style="color: #d4af37; font-size: 20px; margin-bottom: 16px;">🔊 Upload Suara Adzan</h3>
                
                <div style="background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 12px; border: 2px solid #d4af37; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 64px; margin-bottom: 12px;">🎵</div>
                        <div style="color: white; font-size: 16px; margin-bottom: 8px;">
                            ${adzanAudioUrl ? '<span style="color: #4ade80; font-weight: 700;">✅ Suara Adzan Sudah Diupload</span>' : '<span style="color: rgba(255, 255, 255, 0.6);">Belum ada suara adzan</span>'}
                        </div>
                    </div>
                    
                    ${adzanAudioUrl ? `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <div style="color: #d4af37; font-weight: 700; margin-bottom: 12px;">Preview Suara Adzan:</div>
                            <audio id="audio-preview" controls style="width: 100%; margin-bottom: 12px;">
                                <source src="${adzanAudioUrl}" type="audio/mpeg">
                            </audio>
                            <button onclick="removeAdzanAudio()" style="width: 100%; background: #f87171; color: white; border: none; border-radius: 6px; padding: 10px; cursor: pointer; font-weight: 700;">🗑️ HAPUS SUARA ADZAN</button>
                        </div>
                    ` : ''}
                    
                    <input type="file" id="adzan-audio-upload" accept="audio/*" style="display: none;" onchange="handleAdzanAudioUpload(event)">
                    <button onclick="document.getElementById('adzan-audio-upload').click()" style="width: 100%; background: #d4af37; color: #1a4d2e; border: none; border-radius: 8px; padding: 14px; cursor: pointer; font-weight: 700; font-size: 16px;">
                        📁 ${adzanAudioUrl ? 'GANTI' : 'UPLOAD'} SUARA ADZAN
                    </button>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid rgba(212, 175, 55, 0.4);">
                    <div style="color: #d4af37; font-weight: 700; margin-bottom: 8px;">Volume Suara Adzan</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="range" id="adzan-volume-slider" min="0" max="100" value="${Math.round(adzanVolume * 100)}" oninput="updateAdzanVolumeDisplay(this.value)" style="flex: 1;">
                        <div id="adzan-volume-display" style="width: 60px; text-align: right; color: white;">${Math.round(adzanVolume * 100)}%</div>
                    </div>
                    <button onclick="applyAdzanVolume()" style="margin-top: 10px; background: #d4af37; color: #1a4d2e; border: none; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer;"> Terapkan Volume</button>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid rgba(212, 175, 55, 0.4);">
                    <div style="color: #d4af37; font-weight: 700; margin-bottom: 8px;">Durasi Maksimal Adzan</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="range" id="adzan-duration-slider" min="1" max="10" value="${parseInt(adzanMaxMinutes)}" oninput="updateAdzanDurationDisplay(this.value)" style="flex: 1;">
                        <div id="adzan-duration-display" style="width: 80px; text-align: right; color: white;">${parseInt(adzanMaxMinutes)} menit</div>
                    </div>
                    <button onclick="applyAdzanDuration()" style="margin-top: 10px; background: #d4af37; color: #1a4d2e; border: none; border-radius: 6px; padding: 8px 14px; font-weight: 700; cursor: pointer;"> Terapkan Durasi</button>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 8px; border-left: 4px solid #d4af37;">
                    <div style="color: #d4af37; font-weight: 700; margin-bottom: 12px;">💡 Panduan Upload Suara Adzan:</div>
                    <ul style="color: white; font-size: 14px; line-height: 1.8; margin-left: 20px;">
                        <li>Format audio yang didukung: MP3, WAV, OGG, M4A</li>
                        <li>Ukuran file maksimal: <strong>20MB</strong></li>
                        <li>Durasi yang disarankan: <strong>3-5 menit</strong></li>
                        <li>Suara adzan akan otomatis diputar saat waktu adzan tiba</li>
                        <li>Suara akan berhenti setelah 5 menit atau saat pesan iqomah muncul</li>
                    </ul>
                </div>
            `;
        }

        function attachAudioEventListeners() {
            // Event listeners handled by onclick in HTML
        }

        window.handleAdzanAudioUpload = function(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (20MB limit)
                if (file.size > 20 * 1024 * 1024) {
                    showNotification('⚠️ Ukuran file maksimal 20MB!');
                    return;
                }
                
                // Check if file is audio
                if (!file.type.startsWith('audio/')) {
                    showNotification('⚠️ File harus berupa audio (MP3, WAV, OGG, M4A)!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    adzanAudioUrl = e.target.result;
                    showTab('audio'); // Refresh tab to show preview
                    saveToLocalStorage();
                    showNotification('✅ Suara adzan berhasil diupload!');
                };
                reader.onerror = function() {
                    showNotification('❌ Gagal membaca file audio!');
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeAdzanAudio = function() {
            adzanAudioUrl = "";
            if (adzanAudio) {
                adzanAudio.pause();
                adzanAudio.currentTime = 0;
                adzanAudio = null;
            }
            showTab('audio');
            saveToLocalStorage();
            showNotification('✅ Suara adzan berhasil dihapus!');
        };

        window.updateTransparencyDisplay = function(value) {
            const percentage = Math.round(value);
            const decimal = value / 100;
            
            document.getElementById('transparency-display').textContent = percentage + '%';
            
            // Update preview boxes
            const preview1 = document.getElementById('preview-transparency-1');
            const preview2 = document.getElementById('preview-transparency-2');
            
            if (preview1 && preview2) {
                preview1.textContent = percentage + '%';
                preview2.textContent = percentage + '%';
                
                preview1.parentElement.style.background = `rgba(212, 175, 55, ${decimal})`;
                preview1.parentElement.style.border = `2px solid rgba(212, 175, 55, ${decimal})`;
                preview2.parentElement.style.border = `2px solid rgba(212, 175, 55, ${decimal})`;
            }
        };

        window.applyTransparency = function() {
            const slider = document.getElementById('transparency-slider');
            if (slider) {
                transparencyLevel = parseInt(slider.value) / 100;
                updateAllTransparency();
                saveToLocalStorage();
                showNotification('✅ Transparansi berhasil diterapkan!');
            }
        };

        window.updateAdzanVolumeDisplay = function(value) {
            const percentage = Math.round(value);
            const el = document.getElementById('adzan-volume-display');
            if (el) el.textContent = percentage + '%';
            const preview = document.getElementById('audio-preview');
            if (preview) preview.volume = percentage / 100;
        };
        window.applyAdzanVolume = function() {
            const slider = document.getElementById('adzan-volume-slider');
            if (slider) {
                adzanVolume = Math.max(0, Math.min(1, parseInt(slider.value) / 100));
                if (adzanAudio) adzanAudio.volume = adzanVolume;
                saveToLocalStorage();
                showNotification('✅ Volume adzan diterapkan!');
            }
        };
        window.updateAdzanDurationDisplay = function(value) {
            const minutes = Math.max(1, parseInt(value));
            const el = document.getElementById('adzan-duration-display');
            if (el) el.textContent = minutes + ' menit';
        };
        window.applyAdzanDuration = function() {
            const slider = document.getElementById('adzan-duration-slider');
            if (slider) {
                adzanMaxMinutes = Math.max(1, parseInt(slider.value));
                saveToLocalStorage();
                showNotification('✅ Durasi adzan diterapkan!');
            }
        };
        window.updateBeepVolumeDisplay = function(value) {
            const percentage = Math.round(value);
            const el = document.getElementById('beep-volume-display');
            if (el) el.textContent = percentage + '%';
            const preview = document.getElementById('beep-preview');
            if (preview) preview.volume = percentage / 100;
        };
        window.applyBeepVolume = function() {
            const slider = document.getElementById('beep-volume-slider');
            if (slider) {
                beepVolume = Math.max(0, Math.min(1, parseInt(slider.value) / 100));
                if (beepAudio) beepAudio.volume = beepVolume;
                saveToLocalStorage();
                showNotification('✅ Volume beep diterapkan!');
            }
        };

        function updateAllTransparency() {
            // Update prayer cards borders
            const prayerCards = document.querySelectorAll('.prayer-card');
            prayerCards.forEach(card => {
                if (!card.classList.contains('active-prayer')) {
                    card.style.border = `2px solid rgba(212, 175, 55, ${transparencyLevel})`;
                }
            });
            
            // Update takmir display containers
            updateTakmirDisplay();
            
            // Update info masjid
            updateInfoDisplay();
            
            // Update table headers
            const tableHeaders = document.querySelectorAll('thead tr');
            tableHeaders.forEach(header => {
                header.style.borderBottom = `2px solid rgba(212, 175, 55, ${transparencyLevel})`;
            });
            
            // Update table rows
            const tableRows = document.querySelectorAll('.table-row');
            tableRows.forEach(row => {
                row.style.borderBottom = `1px solid rgba(212, 175, 55, ${transparencyLevel})`;
            });
            
            // Update all container borders
            document.querySelectorAll('.gold-border').forEach(el => {
                el.style.border = `2px solid rgba(212, 175, 55, ${transparencyLevel})`;
            });
        }

        window.previewTakmir = function(index) {
            const photoUrl = document.getElementById(`takmir-photo-${index}`).value;
            const previewImg = document.getElementById(`preview-${index}`);
            
            if (photoUrl) {
                const parentDiv = previewImg ? previewImg.parentElement : document.querySelector(`#preview-${index}`).parentElement;
                parentDiv.innerHTML = `<img id="preview-${index}" src="${photoUrl}" style="width: 100%; height: 100%; object-fit: cover;" alt="Preview" onerror="this.style.display='none'; this.parentElement.innerHTML='<svg style=\\'width: 50px; height: 50px; color: #1a4d2e;\\' fill=\\'currentColor\\' viewBox=\\'0 0 20 20\\'><path d=\\'M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z\\'/></svg><div style=\\'color: #f87171; font-size: 10px; margin-top: 4px;\\'>Gagal memuat</div>';">`;
                showNotification('👁️ Preview diupdate!');
            } else {
                showNotification('⚠️ Masukkan URL foto terlebih dahulu!');
            }
        };

        window.clearTakmir = function(index) {
            takmirData[index] = { name: "", position: "", photoUrl: "" };
            updateTakmirDisplay();
            showTab('takmir');
            saveToLocalStorage();
            showNotification('✅ Data takmir berhasil dihapus!');
        };

        window.handleImageUpload = function(index, event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('⚠️ Ukuran file maksimal 5MB!');
                    return;
                }
                
                if (!file.type.startsWith('image/')) {
                    showNotification('⚠️ File harus berupa gambar!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;
                    document.getElementById(`takmir-photo-${index}`).value = dataUrl;
                    
                    const previewImg = document.getElementById(`preview-${index}`);
                    if (previewImg) {
                        const parentDiv = previewImg.parentElement;
                        parentDiv.innerHTML = `<img id="preview-${index}" src="${dataUrl}" style="width: 100%; height: 100%; object-fit: cover;" alt="Preview">`;
                    }
                    
                    showNotification('✅ Foto berhasil diupload!');
                };
                reader.onerror = function() {
                    showNotification('❌ Gagal membaca file!');
                };
                reader.readAsDataURL(file);
            }
        };

        window.handleLeftColImageUpload = function(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('⚠️ Ukuran file maksimal 10MB!');
                    return;
                }
                
                if (!file.type.startsWith('image/')) {
                    showNotification('⚠️ File harus berupa gambar!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;
                    const urlInput = document.getElementById('left-col-image-url');
                    if (urlInput) urlInput.value = dataUrl;
                    
                    const previewContainer = document.querySelector('#left-col-image-upload .preview-box');
                    if (previewContainer) {
                        previewContainer.innerHTML = `<img src="${dataUrl}" style="width: 100%; height: 100%; object-fit: contain;">`;
                    }
                    showNotification('✅ Gambar poster berhasil diupload!');
                };
                reader.onerror = function() {
                    showNotification('❌ Gagal membaca file!');
                };
                reader.readAsDataURL(file);
            }
        };

        // Global functions for delete actions
        window.deleteDonator = function(index) {
            donatorsData.splice(index, 1);
            updateDonaturDisplay();
            showTab('donatur');
            saveToLocalStorage();
            showNotification('✅ Donatur berhasil dihapus!');
        };

        window.updateDonator = function(index) {
            const nameInput = document.getElementById(`edit-donator-name-${index}`);
            const amountInput = document.getElementById(`edit-donator-amount-${index}`);
            if (nameInput && amountInput) {
                const name = nameInput.value;
                const amount = amountInput.value;
                donatorsData[index] = { name, amount };
                updateDonaturDisplay();
                showTab('donatur');
                saveToLocalStorage();
                showNotification('✅ Donatur berhasil diupdate!');
            }
        };

        window.deleteOfficer = function(index) {
            if (officersData.length > 1) {
                officersData.splice(index, 1);
                updateOfficersDisplay();
                showTab('petugas');
                saveToLocalStorage();
                showNotification('✅ Petugas berhasil dihapus!');
            } else {
                showNotification('⚠️ Minimal harus ada 1 petugas!');
            }
        };

        window.saveIdentitas = function() {
            currentMosqueName = document.getElementById('edit-mosque-name').value;
                currentMosqueAddress = document.getElementById('edit-mosque-address').value;
                document.getElementById('mosque-name').textContent = currentMosqueName;
                document.getElementById('mosque-address').textContent = currentMosqueAddress;
                saveToLocalStorage();
                showNotification('✅ Identitas masjid berhasil diupdate!');
        };

        // Update display functions
        function updateInfoDisplay() {
            const infoDiv = document.getElementById('info-masjid-display');
            const items = [];
            if (infoVisibilityConfig.capacity && infoMasjidData.capacity) items.push({ label: 'Kapasitas', value: infoMasjidData.capacity });
            if (infoVisibilityConfig.facilities && infoMasjidData.facilities) items.push({ label: 'Fasilitas', value: infoMasjidData.facilities });
            if (infoVisibilityConfig.iqomah && infoMasjidData.iqomah) items.push({ label: 'Iqomah', value: infoMasjidData.iqomah });
            if (infoVisibilityConfig.contact && infoMasjidData.contact) items.push({ label: 'Kontak', value: infoMasjidData.contact });
            if (infoVisibilityConfig.ramadhan && infoMasjidData.ramadhan) items.push({ label: 'Info Ramadhan/Raya', value: infoMasjidData.ramadhan });
            if (infoVisibilityConfig.qurban && infoMasjidData.qurban) items.push({ label: 'Info Qurban', value: infoMasjidData.qurban });
            if (infoVisibilityConfig.rekening && infoMasjidData.rekening) items.push({ label: 'No. Rekening', value: infoMasjidData.rekening });
            if (infoAutoRotate && items.length > 0) {
                const idx = items.length > 0 ? (infoRotateIndex % items.length) : 0;
                const item = items[idx];
                infoDiv.innerHTML = `
                    <div style="background: rgba(212, 175, 55, 0.1); padding: 6px; border-radius: 6px; border-left: 3px solid #d4af37;">
                        <div style="opacity: 0.8; font-size: 15px; font-weight: 600; margin-bottom: 2px;">${item.label}</div>
                        <div style="font-weight: 700; font-size: 14px;">${item.value}</div>
                    </div>
                `;
                return;
            }
            infoDiv.innerHTML = items.map(item => `
                <div style="background: rgba(212, 175, 55, 0.1); padding: 6px; border-radius: 6px; border-left: 3px solid #d4af37;">
                    <div style="opacity: 0.8; font-size: 15px; font-weight: 600; margin-bottom: 2px;">${item.label}</div>
                    <div style="font-weight: 700; font-size: 14px;">${item.value}</div>
                </div>
            `).join('');
        }

        function startInfoRotation() {
            if (infoRotateTimer) {
                clearInterval(infoRotateTimer);
                infoRotateTimer = null;
            }
            const keys = Object.keys(infoVisibilityConfig).filter(k => infoVisibilityConfig[k]);
            if (keys.length <= 1) {
                updateInfoDisplay();
                return;
            }
            updateInfoDisplay();
            infoRotateTimer = setInterval(() => {
                const activeKeys = Object.keys(infoVisibilityConfig).filter(k => infoVisibilityConfig[k]);
                if (activeKeys.length === 0) {
                    infoRotateIndex = 0;
                    updateInfoDisplay();
                    return;
                }
                infoRotateIndex = (infoRotateIndex + 1) % activeKeys.length;
                updateInfoDisplay();
            }, Math.max(1, parseInt(infoRotateIntervalSec)) * 1000);
        }

        function stopInfoRotation() {
            if (infoRotateTimer) {
                clearInterval(infoRotateTimer);
                infoRotateTimer = null;
            }
        }

        function updateDonaturDisplay() {
            const tbody = document.getElementById('donatur-table');
            const scrollContent = document.getElementById('donatur-scroll-content');
            
            // Check if we need scrolling (more than 5 entries)
            const shouldScroll = donatorsData.length > 5;
            
            // If scrolling, we duplicate the data to create seamless loop
            const displayData = shouldScroll ? [...donatorsData, ...donatorsData] : donatorsData;
            
            tbody.innerHTML = displayData.map(d => `
                <tr class="table-row">
                    <td style="padding: 4px; width: 65%;">${d.name}</td>
                    <td style="padding: 4px; text-align: right; font-weight: 600; width: 35%;">Rp ${d.amount}</td>
                </tr>
            `).join('');
            
            if (scrollContent) {
                if (shouldScroll) {
                    scrollContent.classList.add('scroll-active');
                    // Adjust speed: 2.5 seconds per item seems reasonable
                    const duration = donatorsData.length * 2.5; 
                    scrollContent.style.animationDuration = `${duration}s`;
                } else {
                    scrollContent.classList.remove('scroll-active');
                    scrollContent.style.animationDuration = '0s';
                    scrollContent.style.transform = 'translateY(0)';
                }
            }
        }

        function updateFinanceDisplay() {
            const tbody = document.getElementById('finance-table');
            const balance = parseFloat(financeData.income.replace(/\./g, '')) - parseFloat(financeData.expense.replace(/\./g, ''));
            const content = `
                <tr class="table-row">
                    <td style="padding: 4px;">Pemasukan Hari Ini</td>
                    <td style="padding: 4px; text-align: right; font-weight: 600; color: #4ade80;">Rp ${financeData.todayIncome}</td>
                </tr>
                <tr class="table-row">
                    <td style="padding: 4px;">Pemasukan Mingguan</td>
                    <td style="padding: 4px; text-align: right; font-weight: 600; color: #4ade80;">Rp ${financeData.weeklyIncome}</td>
                </tr>
                <tr class="table-row">
                    <td style="padding: 4px;">Pemasukan Jumat Lalu</td>
                    <td style="padding: 4px; text-align: right; font-weight: 600; color: #4ade80;">Rp ${financeData.fridayIncome}</td>
                </tr>
                <tr class="table-row">
                    <td style="padding: 4px;">Penerimaan</td>
                    <td style="padding: 4px; text-align: right; font-weight: 600; color: #4ade80;">Rp ${financeData.income}</td>
                </tr>
                <tr class="table-row">
                    <td style="padding: 4px;">Pengeluaran</td>
                    <td style="padding: 4px; text-align: right; font-weight: 600; color: #f87171;">Rp ${financeData.expense}</td>
                </tr>
                <tr class="table-row">
                    <td style="padding: 4px;">Pengeluaran Terakhir</td>
                    <td style="padding: 4px; text-align: right; font-weight: 600; color: #f87171;">Rp ${financeData.lastExpense}</td>
                </tr>
                <tr style="border-top: 2px solid #d4af37;">
                    <td style="padding: 4px; font-weight: 700;">Saldo Saat Ini</td>
                    <td style="padding: 4px; text-align: right; font-weight: 700; color: #d4af37;">Rp ${balance.toLocaleString('id-ID')}</td>
                </tr>
            `;
            
            tbody.innerHTML = content;

            // Scroll Logic
            const scrollContainer = document.getElementById('finance-scroll-container');
            const scrollContent = document.getElementById('finance-scroll-content');
            
            if (scrollContainer && scrollContent) {
                // Reset to measure
                scrollContent.classList.remove('scroll-active');
                scrollContent.style.animationDuration = '0s';
                scrollContent.style.transform = 'translateY(0)';
                
                // Force layout update to ensure correct height measurement
                void scrollContent.offsetWidth;

                const contentHeight = scrollContent.scrollHeight;
                const containerHeight = scrollContainer.clientHeight;
                
                // Enable scroll if content overflows
                if (contentHeight > containerHeight) {
                    tbody.innerHTML = content + content; // Duplicate for seamless loop
                    scrollContent.classList.add('scroll-active');
                    // Calculate duration: ~20px/s speed
                    const duration = contentHeight / 20; 
                    scrollContent.style.animationDuration = `${Math.max(duration, 5)}s`;
                }
            }
        }

        function updateOfficersDisplay() {
            const tbody = document.getElementById('officer-table');
            tbody.innerHTML = officersData.map(o => `
                <tr class="table-row">
                    <td style="padding: 3px; font-weight: 700; color: #d4af37;">${o.prayer}</td>
                    <td style="padding: 3px;">${o.imam}</td>
                    <td style="padding: 3px;">${o.muadzin}</td>
                </tr>
            `).join('');
        }

        function showNotification(message) {
            const notif = document.createElement('div');
            notif.textContent = message;
            notif.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4af37; color: #1a4d2e; padding: 16px 24px; border-radius: 8px; font-weight: 700; z-index: 2000; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }
    </script>
    <script>
        // Ensure DOM is fully loaded before running initialization logic
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Display
            updateClock();
            updateCountdown();
            renderPrayerCards();
            updateTakmirDisplay();
            updateAnnouncementDisplay();
            updateInfoDisplay();
            updateDonaturDisplay();
            updateFinanceDisplay();
            updateOfficersDisplay();
            updateAllTransparency();
            if (infoAutoRotate) {
                startInfoRotation();
            }
            
            // Start Clock Interval
            setInterval(() => {
                try {
                    updateClock();
                    updateCountdown();
                    renderPrayerCards();
                } catch (err) {
                    console.error("Error in main interval:", err);
                }
            }, 1000);
        });
    </script>
    <script>
        // --- ACTIVATION LOGIC ---
        const ACTIVATION_STORE_KEY = 'al_majid_client_config';
        let clientConfig = null;

        function checkActivation() {
            const stored = localStorage.getItem(ACTIVATION_STORE_KEY);
            const activationScreen = document.getElementById('activation-screen');
            
            if (stored) {
                try {
                    clientConfig = JSON.parse(stored);
                    
                    // Check expiry if exists
                    if (clientConfig.expiryDate && new Date(clientConfig.expiryDate) < new Date()) {
                        alert("Masa berlaku aktivasi telah habis. Silakan aktivasi ulang.");
                        localStorage.removeItem(ACTIVATION_STORE_KEY);
                        activationScreen.classList.remove('hidden');
                    } else if (clientConfig.status === 'BLOCKED') {
                        alert("Perangkat ini telah diblokir.");
                        activationScreen.classList.remove('hidden');
                    } else {
                        // Valid activation
                        activationScreen.classList.add('hidden');
                        
                        // Update mosque name if available in config
                        if (clientConfig.mosqueName) {
                            const mosqueNameEl = document.getElementById('mosque-name');
                            if (mosqueNameEl) mosqueNameEl.textContent = clientConfig.mosqueName;
                        }
                    }
                } catch (e) {
                    console.error("Activation data corrupt", e);
                    activationScreen.classList.remove('hidden');
                }
            } else {
                activationScreen.classList.remove('hidden');
            }

            // File Upload Listener
            const fileInput = document.getElementById('act-file');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('act-data').value = e.target.result;
                    };
                    reader.readAsText(file);
                });
            }
        }

        window.attemptActivation = function() {
            const codeInput = document.getElementById('act-code').value.trim().toUpperCase();
            const dataInput = document.getElementById('act-data').value.trim();
            const errorMsg = document.getElementById('act-error');

            if (!codeInput || !dataInput) {
                errorMsg.textContent = "Mohon lengkapi Kode dan Data Master.";
                errorMsg.style.display = 'block';
                return;
            }

            try {
                // Parse Master Data
                const masterData = JSON.parse(dataInput);
                
                // Find Code
                if (!Array.isArray(masterData)) throw new Error("Format data salah");
                
                const found = masterData.find(item => item.code === codeInput);

                if (found) {
                    if (found.status !== 'ACTIVE') {
                        errorMsg.textContent = "Kode ini statusnya NONAKTIF/BLOKIR.";
                        errorMsg.style.display = 'block';
                        return;
                    }

                    // Success! Save only relevant data
                    const configToSave = {
                        code: found.code,
                        mosqueName: found.mosqueName,
                        expiryDate: found.expiryDate,
                        activatedAt: new Date().toISOString(),
                        status: 'ACTIVE'
                    };

                    localStorage.setItem(ACTIVATION_STORE_KEY, JSON.stringify(configToSave));
                    clientConfig = configToSave;
                    
                    alert("Aktivasi Berhasil! Selamat Datang.");
                    location.reload(); // Reload to apply changes cleanly

                } else {
                    errorMsg.textContent = "Kode Aktivasi tidak ditemukan dalam Data Master yang dimasukkan.";
                    errorMsg.style.display = 'block';
                }

            } catch (e) {
                errorMsg.textContent = "Format Data Master JSON tidak valid. Pastikan Anda upload file dari Master.";
                errorMsg.style.display = 'block';
                console.error(e);
            }
        };

        // Run check on load
        document.addEventListener('DOMContentLoaded', checkActivation);
    </script>
</body>
</html>
